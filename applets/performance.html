<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1.1 小程序的工作原理 | web全栈体系</title>
    <meta name="description" content="你好，朋友">
    <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.5718d53e.css" as="style"><link rel="preload" href="/assets/js/app.0f616eb6.js" as="script"><link rel="preload" href="/assets/js/3.9750fba5.js" as="script"><link rel="preload" href="/assets/js/2.6aa46093.js" as="script"><link rel="preload" href="/assets/js/21.56a0a87d.js" as="script"><link rel="preload" href="/assets/js/27.c05d3044.js" as="script"><link rel="prefetch" href="/assets/js/10.3b417cc7.js"><link rel="prefetch" href="/assets/js/100.450b51bc.js"><link rel="prefetch" href="/assets/js/101.02365136.js"><link rel="prefetch" href="/assets/js/102.23f6118f.js"><link rel="prefetch" href="/assets/js/103.4decf838.js"><link rel="prefetch" href="/assets/js/104.d39cfd73.js"><link rel="prefetch" href="/assets/js/105.88534338.js"><link rel="prefetch" href="/assets/js/106.366d0b59.js"><link rel="prefetch" href="/assets/js/107.cf3cfcba.js"><link rel="prefetch" href="/assets/js/108.21694919.js"><link rel="prefetch" href="/assets/js/109.4e4fd62e.js"><link rel="prefetch" href="/assets/js/11.9d20f01b.js"><link rel="prefetch" href="/assets/js/110.aeb394e4.js"><link rel="prefetch" href="/assets/js/111.d6595775.js"><link rel="prefetch" href="/assets/js/12.ac6dcc46.js"><link rel="prefetch" href="/assets/js/13.3990b71a.js"><link rel="prefetch" href="/assets/js/14.42418305.js"><link rel="prefetch" href="/assets/js/15.3e7fea41.js"><link rel="prefetch" href="/assets/js/16.e9242241.js"><link rel="prefetch" href="/assets/js/17.5cb2a82b.js"><link rel="prefetch" href="/assets/js/18.09a2ee08.js"><link rel="prefetch" href="/assets/js/19.5e018236.js"><link rel="prefetch" href="/assets/js/20.2f6aad81.js"><link rel="prefetch" href="/assets/js/22.37a8fef4.js"><link rel="prefetch" href="/assets/js/23.75c65558.js"><link rel="prefetch" href="/assets/js/24.19255d9b.js"><link rel="prefetch" href="/assets/js/25.b96e970c.js"><link rel="prefetch" href="/assets/js/26.8043101d.js"><link rel="prefetch" href="/assets/js/28.c0aa90a2.js"><link rel="prefetch" href="/assets/js/29.06c0191d.js"><link rel="prefetch" href="/assets/js/30.975fb305.js"><link rel="prefetch" href="/assets/js/31.0cba5310.js"><link rel="prefetch" href="/assets/js/32.d8bc188f.js"><link rel="prefetch" href="/assets/js/33.384f6578.js"><link rel="prefetch" href="/assets/js/34.6baca6a7.js"><link rel="prefetch" href="/assets/js/35.96ec3f3e.js"><link rel="prefetch" href="/assets/js/36.bd945c36.js"><link rel="prefetch" href="/assets/js/37.be27655b.js"><link rel="prefetch" href="/assets/js/38.e8e93b37.js"><link rel="prefetch" href="/assets/js/39.ef88fac1.js"><link rel="prefetch" href="/assets/js/4.aa28cc69.js"><link rel="prefetch" href="/assets/js/40.b6dad60d.js"><link rel="prefetch" href="/assets/js/41.c762ef5a.js"><link rel="prefetch" href="/assets/js/42.151d8a58.js"><link rel="prefetch" href="/assets/js/43.632c642f.js"><link rel="prefetch" href="/assets/js/44.2e34b5d9.js"><link rel="prefetch" href="/assets/js/45.94f8db29.js"><link rel="prefetch" href="/assets/js/46.57527f8f.js"><link rel="prefetch" href="/assets/js/47.44a84132.js"><link rel="prefetch" href="/assets/js/48.66958018.js"><link rel="prefetch" href="/assets/js/49.21739b30.js"><link rel="prefetch" href="/assets/js/5.e06ff02e.js"><link rel="prefetch" href="/assets/js/50.000c5d7c.js"><link rel="prefetch" href="/assets/js/51.b59a6470.js"><link rel="prefetch" href="/assets/js/52.3a475ad4.js"><link rel="prefetch" href="/assets/js/53.9801890b.js"><link rel="prefetch" href="/assets/js/54.269a45cd.js"><link rel="prefetch" href="/assets/js/55.91e89997.js"><link rel="prefetch" href="/assets/js/56.493b7ae8.js"><link rel="prefetch" href="/assets/js/57.ec46c27c.js"><link rel="prefetch" href="/assets/js/58.56202f8d.js"><link rel="prefetch" href="/assets/js/59.4dac8d8a.js"><link rel="prefetch" href="/assets/js/6.45a79ebc.js"><link rel="prefetch" href="/assets/js/60.77f7cd1f.js"><link rel="prefetch" href="/assets/js/61.a48bae63.js"><link rel="prefetch" href="/assets/js/62.626e88b6.js"><link rel="prefetch" href="/assets/js/63.9d36ed5d.js"><link rel="prefetch" href="/assets/js/64.a6a4e5c6.js"><link rel="prefetch" href="/assets/js/65.e32c3a18.js"><link rel="prefetch" href="/assets/js/66.0de20cc0.js"><link rel="prefetch" href="/assets/js/67.b24d4adf.js"><link rel="prefetch" href="/assets/js/68.7269173e.js"><link rel="prefetch" href="/assets/js/69.9999d01e.js"><link rel="prefetch" href="/assets/js/7.1a1f32a2.js"><link rel="prefetch" href="/assets/js/70.a45e1785.js"><link rel="prefetch" href="/assets/js/71.d443735d.js"><link rel="prefetch" href="/assets/js/72.56bd9ca0.js"><link rel="prefetch" href="/assets/js/73.4a484020.js"><link rel="prefetch" href="/assets/js/74.d0f77ba8.js"><link rel="prefetch" href="/assets/js/75.8595de75.js"><link rel="prefetch" href="/assets/js/76.b89309e6.js"><link rel="prefetch" href="/assets/js/77.1a28c952.js"><link rel="prefetch" href="/assets/js/78.156340fe.js"><link rel="prefetch" href="/assets/js/79.bc68f887.js"><link rel="prefetch" href="/assets/js/8.ffcc6d32.js"><link rel="prefetch" href="/assets/js/80.00742412.js"><link rel="prefetch" href="/assets/js/81.d07bf30f.js"><link rel="prefetch" href="/assets/js/82.dd648b4e.js"><link rel="prefetch" href="/assets/js/83.50310bd1.js"><link rel="prefetch" href="/assets/js/84.8b446b87.js"><link rel="prefetch" href="/assets/js/85.1bbf1222.js"><link rel="prefetch" href="/assets/js/86.b1112682.js"><link rel="prefetch" href="/assets/js/87.5353ad37.js"><link rel="prefetch" href="/assets/js/88.3bc7938a.js"><link rel="prefetch" href="/assets/js/89.c9d6877e.js"><link rel="prefetch" href="/assets/js/9.bfaf9c10.js"><link rel="prefetch" href="/assets/js/90.f7c20556.js"><link rel="prefetch" href="/assets/js/91.72437dd2.js"><link rel="prefetch" href="/assets/js/92.2a17869e.js"><link rel="prefetch" href="/assets/js/93.cc33ea11.js"><link rel="prefetch" href="/assets/js/94.49e5d122.js"><link rel="prefetch" href="/assets/js/95.9c954379.js"><link rel="prefetch" href="/assets/js/96.638e1dee.js"><link rel="prefetch" href="/assets/js/97.c2372908.js"><link rel="prefetch" href="/assets/js/98.762254ac.js"><link rel="prefetch" href="/assets/js/99.29af3121.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5718d53e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-266a5a28><header class="navbar" data-v-266a5a28><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="web全栈体系" class="logo"> <span class="site-name can-hide">web全栈体系</span></a> <div class="carousel" data-v-1a4d21d9></div> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><a href="https://github.com/hejialianghe" class="repo-star"><img src="https://img.shields.io/github/stars/hejialianghe/Senior-FrontEnd.svg?style=flat-square" alt></a> <div class="nav-item"><a href="/algorithm/complexity.html" class="nav-link">算法小册</a></div><div class="nav-item"><a href="/guide/" class="nav-link">web体系</a></div><div class="nav-item"><a href="/fp/react/build-react.html" class="nav-link">框架原理</a></div><div class="nav-item"><a href="https://github.com/hejialianghe/Senior-FrontEnd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee.com/hejialianghe/Senior-FrontEnd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="选择语言" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/applets/performance.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en-US/applets/performance.html" class="nav-link">English</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-266a5a28></div> <aside class="sidebar" data-v-266a5a28><nav class="nav-links"><a href="https://github.com/hejialianghe" class="repo-star"><img src="https://img.shields.io/github/stars/hejialianghe/Senior-FrontEnd.svg?style=flat-square" alt></a> <div class="nav-item"><a href="/algorithm/complexity.html" class="nav-link">算法小册</a></div><div class="nav-item"><a href="/guide/" class="nav-link">web体系</a></div><div class="nav-item"><a href="/fp/react/build-react.html" class="nav-link">框架原理</a></div><div class="nav-item"><a href="https://github.com/hejialianghe/Senior-FrontEnd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee.com/hejialianghe/Senior-FrontEnd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="选择语言" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/applets/performance.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en-US/applets/performance.html" class="nav-link">English</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" class="sidebar-link">介绍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jsadvanced/" class="sidebar-link">前言</a></li><li><a href="/jsadvanced/function.html" class="sidebar-link">函数</a></li><li><a href="/jsadvanced/asyncpro.html" class="sidebar-link">异步编程</a></li><li><a href="/jsadvanced/designpattern.html" class="sidebar-link">设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>计算机网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/computerNetwork/protocal.html" class="sidebar-link">网络协议</a></li><li><a href="/computerNetwork/network-actual.html" class="sidebar-link">网络请求实战</a></li><li><a href="/computerNetwork/security.html" class="sidebar-link">网络安全与攻防</a></li><li><a href="/computerNetwork/browser-status.html" class="sidebar-link">浏览器状态同步和路由</a></li><li><a href="/computerNetwork/tools.html" class="sidebar-link">工具链和其他</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/" class="sidebar-link">前言</a></li><li><a href="/vue/vueBase.html" class="sidebar-link">vue基础</a></li><li><a href="/vue/vueComponents.html" class="sidebar-link">探索vue的组件世界</a></li><li><a href="/vue/sourceCode.html" class="sidebar-link">部分源码解析</a></li><li><a href="/vue/serverSideRender.html" class="sidebar-link">服务端渲染</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>react</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/" class="sidebar-link">入门介绍</a></li><li><a href="/react/react-base.html" class="sidebar-link">步入react</a></li><li><a href="/react/react-positive.html" class="sidebar-link">react正篇</a></li><li><a href="/react/react-ecology.html" class="sidebar-link">react生态</a></li><li><a href="/react/react-principle.html" class="sidebar-link">react原理</a></li><li><a href="/react/react-state-mana.html" class="sidebar-link">react状态管理</a></li><li><a href="/react/react-actualCombat.html" class="sidebar-link">react高级实战</a></li><li><a href="/react/react-hooks.html" class="sidebar-link">react-hooks</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Node.js进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node/" class="sidebar-link">Node.js基础</a></li><li><a href="/node/koa.html" class="sidebar-link">koa</a></li><li><a href="/node/egg.html" class="sidebar-link">企业级框架egg</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工程化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/engineering/script.html" class="sidebar-link">脚本世界</a></li><li><a href="/engineering/coding-standards.html" class="sidebar-link">规范先行</a></li><li><a href="/engineering/quality-code.html" class="sidebar-link">质量代码</a></li><li><a href="/engineering/design.html" class="sidebar-link">工程设计</a></li><li><a href="/engineering/ctg-art.html" class="sidebar-link">构建艺术</a></li><li><a href="/engineering/auto-deploy.html" class="sidebar-link">持续集成与部署</a></li><li><a href="/engineering/git.html" class="sidebar-link">Git操作</a></li><li><a href="/engineering/tool.html" class="sidebar-link">效率工具</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>小程序</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/applets/performance.html" aria-current="page" class="active sidebar-link">小程序进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/applets/performance.html#_1-1-小程序的工作原理" class="sidebar-link">1.1 小程序的工作原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/applets/performance.html#_1-1-1-双线程架构和exparser框架" class="sidebar-link">1.1.1 双线程架构和Exparser框架</a></li><li class="sidebar-sub-header"><a href="/applets/performance.html#_1-1-2-web和native的通信原理" class="sidebar-link">1.1.2 Web和Native的通信原理</a></li><li class="sidebar-sub-header"><a href="/applets/performance.html#_1-1-3-原生组件和同层渲染" class="sidebar-link">1.1.3 原生组件和同层渲染</a></li></ul></li><li class="sidebar-sub-header"><a href="/applets/performance.html#_1-2-性能优化" class="sidebar-link">1.2 性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/applets/performance.html#_1-2-1-加快小程序的启动速度" class="sidebar-link">1.2.1 加快小程序的启动速度</a></li><li class="sidebar-sub-header"><a href="/applets/performance.html#_1-2-2-加快小程序的首屏渲染" class="sidebar-link">1.2.2 加快小程序的首屏渲染</a></li><li class="sidebar-sub-header"><a href="/applets/performance.html#_1-2-3-加快小程序的动态渲染" class="sidebar-link">1.2.3 加快小程序的动态渲染</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>项目实战</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/projectPractice/isomorphism.html" class="sidebar-link">认识同构及原理</a></li><li><a href="/projectPractice/demo.html" class="sidebar-link">实现一个同构的demo</a></li><li><a href="/projectPractice/nextjs.html" class="sidebar-link">Nextjs</a></li></ul></section></li></ul> </aside> <main class="page" data-v-266a5a28> <div class="ads" data-v-a4c8d602><div class="item" data-v-a4c8d602><h6 class="title" style="display:;" data-v-a4c8d602>联系作者</h6> <div class="thumb" data-v-a4c8d602><a href="/weixin.jpeg" target="_blank" data-v-a4c8d602><img src="/weixin.jpeg" alt="联系作者" data-v-a4c8d602></a></div></div></div> <div class="theme-default-content content__default"><h2 id="_1-1-小程序的工作原理"><a href="#_1-1-小程序的工作原理" class="header-anchor">#</a> 1.1 小程序的工作原理</h2> <h3 id="_1-1-1-双线程架构和exparser框架"><a href="#_1-1-1-双线程架构和exparser框架" class="header-anchor">#</a> 1.1.1 双线程架构和Exparser框架</h3> <h4 id="常见的页面渲染方式"><a href="#常见的页面渲染方式" class="header-anchor">#</a> 常见的页面渲染方式</h4> <ol><li>Naitve：流畅度好，但是修改和发布不够灵活</li> <li>Web渲染：修改和发布灵活，但是加载可能不稳定，渲染有时不够流畅</li> <li>Hybrid渲染：技术方案较多，需要选型和精心设计，找到兼顾速度和流畅性的方案</li></ol> <h4 id="hybrid渲染"><a href="#hybrid渲染" class="header-anchor">#</a> Hybrid渲染</h4> <p>Naitve和Web都有它们的优势和劣势，我们想有一种混合的方案去中和它们的优势和劣势，达到一个平衡的效果，下面有3种方案</p> <ul><li>PhoneGap：跑的还是常见web页面，只是在页面包了一层壳，native提供一些api调用，它确实有些原生的体验</li> <li>React-Native：能达到原生体验，但稳定性没那么好</li> <li>JS-SDK：提供了一些拍照、扫一扫的原生能力</li></ul> <h4 id="微信小程序的选择"><a href="#微信小程序的选择" class="header-anchor">#</a> 微信小程序的选择</h4> <p>基于JS-SDK和资源离线缓存的Hybrid方案</p> <ul><li>界面渲染采用Web技术</li> <li>页面使用独立的Webview渲染</li> <li>资源打包一次下载后缓存使用，并且异步更新</li> <li>提供原生组件和原生能力调用接口</li></ul> <h4 id="双线程架构"><a href="#双线程架构" class="header-anchor">#</a> 双线程架构</h4> <p><img src="/assets/img/duble_layer.e631c124.png" alt=""></p> <p>小程序分为<code>逻辑层</code>、<code>渲染层</code>，它们之间的通信需要通过<code>native</code>;每打开一个页面会开辟一个webview，它们独立渲染；所以返回的时候，直接从内存里加载</p> <p>优点：</p> <ol><li>流畅性：渲染层和逻辑层分别运行在不同的线程，互不阻塞</li> <li>安全性：逻辑层无法直接修改渲染层的内容，也无法直接获取敏感数据</li> <li>灵活轻量：基础库集成在微信端，业务代码轻量话，两者都可以远程更新</li> <li>渲染主要还是web技术，具备了Web开发的效率和灵活</li></ol> <p>缺点：</p> <ol><li>开发成本：与传统开发有所区别的语法和结构，已有的的功能无法直接运行在小程序上，需要移植成本</li> <li>非实时性：由于渲染层和逻辑层的分离，大多数操作都变成了异步，复杂场景处理繁琐</li> <li>能力限制：页面大小，打开数量和内存回收都存在限制和一定的不可控性</li> <li>性能优化：与传统的web开发的性能问题有所不同，需要另行优化性能问题</li></ol> <h4 id="exparser框架"><a href="#exparser框架" class="header-anchor">#</a> Exparser框架</h4> <p>微信小程序中负责组件的组织框架，包括内置组件和自定义组件的管理</p> <ul><li>基于shadow DOM模型，但是又不依赖浏览器和其他工具库</li> <li>可在JS环境中运行，使的逻辑层和渲染层模型一致</li> <li>高效轻量，性能表现好，在组件实例极多的环境下表现尤其优异，同时代码尺寸也较小</li></ul> <p>自定义组件的创建流程</p> <ol><li>以Component构造器的内容创建组件对象</li> <li>为组件对象添加注册时声明的data</li> <li>结合WXML，生成组件Shadow Tree</li> <li>Shadow Tree装入Compose Tree</li> <li>依次触发组件的created、attached等事件</li></ol> <h3 id="_1-1-2-web和native的通信原理"><a href="#_1-1-2-web和native的通信原理" class="header-anchor">#</a> 1.1.2 Web和Native的通信原理</h3> <h4 id="web发送数据到native"><a href="#web发送数据到native" class="header-anchor">#</a> Web发送数据到Native <span class="badge tip" style="vertical-align:top;" data-v-76652c5d>重要</span></h4> <ul><li>拦截URL Scheme ：Native的WebView拦截Web页面发出的特定格式的网络请求</li> <li>拦截prompt API ：Native的WebView拦截Web页面中的window.prompt等api的调用</li> <li>Native API注入：Native在javaScript环境上下文直接注入javascript方法以供调用</li></ul> <h4 id="_1-拦截url-scheme"><a href="#_1-拦截url-scheme" class="header-anchor">#</a> 1. 拦截URL Scheme</h4> <p><code>net://post?id=123</code> net是自定义的协议，可以定义成net也可以是abc等</p> <ul><li>Scheme就是应用自定义的URL协议名，如上面代码中的netease</li> <li>客户端可以通过API对WebView发出的请求进行捕获并根据Scheme决定是否拦截和解析</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 这种方式不推荐，只适用于demo或低频场景</span>
<span class="token comment">// 因为多次连续调用时，客户端只会收到最后一次消息</span>
location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">&quot;net://post?id=3&quot;</span>

<span class="token comment">// 推荐使用这种方式，消息不会丢失</span>
<span class="token keyword">const</span> iframe <span class="token operator">=</span> doucment<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span>
iframe<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display<span class="token operator">=</span><span class="token string">'none'</span>
iframe<span class="token punctuation">.</span>src<span class="token operator">=</span><span class="token string">'net://post?id=123'</span>
doucment<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    iframe<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment">// ios端：可以接收至少3000w个字符的URL；</span>
<span class="token comment">// Android端可以接收至少200w个字符的URL</span>
<span class="token comment">// 消息太长不利于性能；需要考虑是否直接传输这么大量的数据</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>优点：</p> <ul><li>发送简单（location.href或iframe.src）</li> <li>兼容性强（IOS2.0+ Android 1.0+）</li> <li>侵入性低
缺点：</li> <li>消息长度限制（？）</li> <li>过于灵活，缺少限制，容易出错</li></ul> <h4 id="_2-拦截prompt-api"><a href="#_2-拦截prompt-api" class="header-anchor">#</a> 2. 拦截prompt API</h4> <ul><li>Native可以捕获和拦截WebView中<code>alert/confirm/console/prompt</code>等API的调用</li> <li>一般拦截prompt较多，因为该方法使用的使用的频率较低，不容易冲突
<ul><li>IOS：runJavaScriptTextInputPanelWithPrompt</li> <li>Android：WebChromeClient.onJsPrompt</li></ul></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 最好先判断是否处于APP内的WebView再调用</span>
<span class="token keyword">const</span> isInAPP <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">net</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span>
isInAPP <span class="token operator">&amp;&amp;</span> <span class="token function">prompt</span><span class="token punctuation">(</span><span class="token string">'post?id=1'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_2-native-直接注入"><a href="#_2-native-直接注入" class="header-anchor">#</a> 2.Native 直接注入</h4> <ul><li>WebView中的javascript是运行于WebView所提供的环境中的，所以Native可以通过WebView直接介入javascript的执行环境（context）</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// IOS UIWebview</span>
JScontext <span class="token operator">*</span>context<span class="token operator">=</span><span class="token punctuation">[</span>uiWebViewvalueForKeyPath：<span class="token string">&quot;documentView.webView.mainFrame.javascriptContext&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

context<span class="token punctuation">[</span><span class="token string">&quot;postBridgeMessage&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">(</span>NSArray<span class="token operator">&lt;</span>NSArray <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">*</span>calls<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// Native 逻辑</span>
<span class="token punctuation">}</span>
<span class="token comment">// Android</span>
<span class="token comment">// 其中@javascriptInterface注解是安全机制，可以搜索后详细了解</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BridgeLogic</span> <span class="token punctuation">{</span>
    <span class="token comment">// @JavascriptInterface</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendData</span><span class="token punctuation">(</span><span class="token parameter">String message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// native 逻辑</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    webView<span class="token operator">=</span><span class="token punctuation">(</span>WebView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token constant">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>webview<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 开启webview Javascript 手动执行 默认为false</span>
    webview<span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setJavascriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// 传入BridgeLogic的实例并挂载到Javascript中 window.JSBridge上</span>
    webview<span class="token punctuation">.</span><span class="token function">addJavascriptInterface</span><span class="token punctuation">(</span><span class="token keyword">new</span>  <span class="token class-name">BridgeLogic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;JSBridge&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Web端的Javascript调用代码</span>
<span class="token comment">// IOS UIWebView内</span>
window<span class="token punctuation">.</span><span class="token function">postBridgeMessage</span><span class="token punctuation">(</span><span class="token string">'post?id=123'</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span>JSBridge<span class="token punctuation">.</span><span class="token function">sendData</span><span class="token punctuation">(</span><span class="token string">'post?id=123'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>优点：</p> <ul><li>执行效率相对较高
缺点：</li> <li>数据格式灵活，但学习成本较高</li> <li>两端耦合性较强</li> <li>可能出现命名空间冲突（window对象）</li></ul> <h4 id="native发送数据到web"><a href="#native发送数据到web" class="header-anchor">#</a> Native发送数据到Web <span class="badge tip" style="vertical-align:top;" data-v-76652c5d>重要</span></h4> <p>我们可以注册一个方法到window上,native可以调用此方法并传值</p> <ul><li>ios：stringByEvaluatingjavaScriptFromString(该方法可以直接获取到javascript的执行结果)</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Swift</span>
<span class="token keyword">let</span> title <span class="token operator">=</span> webview<span class="token punctuation">.</span><span class="token function">stringByEvakuatingjavaScriptFromString</span><span class="token punctuation">(</span><span class="token string">&quot;document.title&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// OC</span>
NSString<span class="token operator">*</span>title <span class="token operator">=</span> <span class="token punctuation">[</span>webview stringByEvakuatingjavaScriptFromString<span class="token operator">:</span>@<span class="token string">&quot;document.title&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>Android：loadUrl(4.4,无法直接获取javascript的执行结果)</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// java</span>
webView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">&quot;javascript:alert('NativeMessage')&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>Android：evaluatejavascript(4.4+,可以直接获取到javascript的执行结果)</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// java</span>
mWebView<span class="token punctuation">.</span><span class="token function">evaluatejavascript</span><span class="token punctuation">(</span><span class="token string">&quot;javascript:document.title&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ValueCallback</span><span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    @Override
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceiveValue</span><span class="token punctuation">(</span><span class="token parameter">Strinf value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 此处为js 返回结果</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_1-1-3-原生组件和同层渲染"><a href="#_1-1-3-原生组件和同层渲染" class="header-anchor">#</a> 1.1.3 原生组件和同层渲染</h3> <h4 id="原生组件"><a href="#原生组件" class="header-anchor">#</a> 原生组件</h4> <p>原生组件的优点：</p> <ul><li>扩展Web的能力：比如输入框对键盘的更好的控制</li> <li>更好的体验：将地图、视频交互由Native线程渲染，不占用Webview渲染线程</li> <li>更快的性能L：在一些高频操作场景下，可以绕过setData通信流程直接渲染</li></ul> <p>原生组件的限制：</p> <ul><li>css支持不全</li> <li>ui渲染方面的限制</li> <li>只能在最高层级</li> <li>事件模型的限制</li></ul> <p>开发中涉及到原生组件的调试时，最好在真机环境下进行验证，开发者工具无法完全模拟原生组件的特性</p> <h4 id="同层渲染"><a href="#同层渲染" class="header-anchor">#</a> 同层渲染</h4> <p>由于原生组件带来的限制，微信研制除了同层渲染，原生组件个webview是同一层了，解决了事件绑定和css问题
<img src="/assets/img/same-rendering.57ae7502.png" alt=""></p> <h4 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h4> <p>ios</p> <ul><li>wkWebView会为overflow:scroll的元素生成原生渲染层WKChildScrollView</li> <li>原生渲染层与其他Web元素的渲染关系已经由WKWebView内部维护好</li> <li>原生组件就可以插入到因为Scroll而生成的原生渲染层中</li></ul> <p>Android</p> <ul><li>Chromium内部存在embed类型的节点</li> <li>Chromium会为Webview内embed节点创建Webplugin实例，并生成一个RenderLayer</li> <li>RenderLayer可以渲染外部设置的内容</li> <li>小程序就可以将原生组件的内容渲染到对应的embed节点生成的RenderLayer上</li></ul> <p>利用embed渲染pdf，小程序也是利用这个特性实现了同层渲染
<img src="/assets/img/pdf.fc5874af.png" alt=""></p> <h4 id="同层渲染后"><a href="#同层渲染后" class="header-anchor">#</a> 同层渲染后</h4> <p>css支持更好：position、margin、box-shadow、transform等都基本支持
渲染层级可控：可以使用z-index控制原生组件的渲染层级
事件机制正常：原生组件上的事件可以冒泡到父元素上进行监听或阻止
依然有一些限制：</p> <ul><li>避免频繁修改CSS</li> <li>不能通过本组件或者父组件设置border-radius截取显示内容</li> <li>低版本安卓可能不支持</li> <li>原生组件全屏后原生组件外的元素将不可见</li></ul> <h2 id="_1-2-性能优化"><a href="#_1-2-性能优化" class="header-anchor">#</a> 1.2 性能优化</h2> <h4 id="性能优化的意义"><a href="#性能优化的意义" class="header-anchor">#</a> 性能优化的意义</h4> <p>小程序也需要性能优化</p> <ul><li>冷启动载入慢，loading状态较长（冷启动：首次启动）</li> <li>数据量较大的页面更新不及时，滚动卡顿</li> <li>一些触摸反馈类的功能不流畅</li></ul> <h3 id="_1-2-1-加快小程序的启动速度"><a href="#_1-2-1-加快小程序的启动速度" class="header-anchor">#</a> 1.2.1 加快小程序的启动速度</h3> <h4 id="启动速度"><a href="#启动速度" class="header-anchor">#</a> 启动速度</h4> <p>核心：减少小程序启动时所需要下载的包体积</p> <ol><li>使用分包
<ul><li>小程序的非首页或非重要页面放入分包中，可以非常有效地减少首次下载的包体积</li> <li>分包还可以提升小程序整体的包体积上限，也有助于后续的首屏渲染加速</li></ul></li></ol> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token string">&quot;pages/index/index&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;subpackages&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token property">&quot;root&quot;</span><span class="token operator">:</span><span class="token string">&quot;packageA&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">&quot;pages/share/index&quot;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="2"><li>分包预下载</li></ol> <ul><li>正常情况下，只有在访问到了分包页面的情况下，分包才会触发下载，降低了分包页面的打开速度</li> <li>分包预下载可以实现访问到某个页面时，自动预下载分包的内容，做到提前下载分包，同时又不影响主包的加载速度</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token string">&quot;pages/index/index&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;subpackages&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token property">&quot;root&quot;</span><span class="token operator">:</span><span class="token string">&quot;packageA&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;nameA&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">&quot;pages/share/index&quot;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;preloadRule&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;pages/share/index&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;network&quot;</span><span class="token operator">:</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 什么网络情况下预下载，wifi/all</span>
            <span class="token property">&quot;packages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;packageA&quot;</span><span class="token punctuation">]</span> <span class="token comment">// 分包的root和name</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ol start="3"><li>独立分包
<ul><li>独立分包可以独立于主包运行，不需要下载主包</li> <li>进入普通分包或主包页面时，主包才被下载</li> <li>独立分包也可以配置预下载主包</li> <li>一个小程序可以有多个独立分包</li></ul></li></ol> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token string">&quot;pages/index/index&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;subpackages&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token property">&quot;root&quot;</span><span class="token operator">:</span><span class="token string">&quot;packageA&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;nameA&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">&quot;pages/share/index&quot;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;independent&quot;</span><span class="token operator">:</span><span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;preloadRule&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;pages/share/index&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;network&quot;</span><span class="token operator">:</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 什么网络情况下预下载，wifi/all</span>
            <span class="token property">&quot;packages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;__APP__&quot;</span><span class="token punctuation">]</span> <span class="token comment">// 可以预下载主包</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ol start="4"><li>优化启动速度的其他方式</li></ol> <ul><li>删除无用代码，并开启上传压缩，降低包体积</li> <li>减少包内图片大小和数量，并推荐使用Webp格式图片</li> <li>适当使用web-view组件</li></ul> <h3 id="_1-2-2-加快小程序的首屏渲染"><a href="#_1-2-2-加快小程序的首屏渲染" class="header-anchor">#</a> 1.2.2 加快小程序的首屏渲染</h3> <ul><li><p>分块渲染：优先渲染屏幕高度的内容，其他内容待ready后再渲染</p></li> <li><p>数据预拉取：配置首屏数据接口预拉取或则周期性更新，节省数据请求时间</p></li> <li><p>骨架屏：使用骨架屏幕，降低用户可感知的页面渲染时间</p></li> <li><p>避免多余数据：</p> <ul><li>避免空的生命周期方法</li> <li>减少初始化阶段的同步形式的方法调用</li> <li>避免过多或过复杂的主包页面和过多的自定义组件</li> <li>不参与渲染的数据采用纯数据字段</li></ul> <h4 id="数据预拉取和周期性更新"><a href="#数据预拉取和周期性更新" class="header-anchor">#</a> 数据预拉取和周期性更新</h4> <ul><li>数据预拉取可以在小程序冷启动的同时，提前拉取指定接口的数据，节省数据的请求时间</li> <li>周期性更新可以按小程序的配置，每隔12小时定时拉取指定接口的数据，不需要小程序被启动，但是需要7天内被使用过</li></ul></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wx<span class="token punctuation">.</span><span class="token function">setBackgroundFethcToken</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            token<span class="token operator">:</span><span class="token string">'xxx'</span> <span class="token comment">// 可以发送小程序存储的用户标识</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        wx<span class="token punctuation">.</span><span class="token function">getBackgroundFetchData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            fetch<span class="token operator">:</span><span class="token string">'pre/periodic'</span><span class="token punctuation">,</span> <span class="token comment">// 预拉取或者周期性更新类型</span>
            <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>fetchData<span class="token punctuation">)</span> <span class="token comment">// 缓存数据</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>timeStamp<span class="token punctuation">)</span> <span class="token comment">// 客户端拿到缓存数据的时间戳</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="首屏渲染-骨架屏"><a href="#首屏渲染-骨架屏" class="header-anchor">#</a> 首屏渲染--骨架屏</h4> <p><a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/skeleton.html" target="_blank" rel="noopener noreferrer">骨架屏文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>用开发者工具生成，然后引入业务页面，显示隐藏即可</p> <h3 id="_1-2-3-加快小程序的动态渲染"><a href="#_1-2-3-加快小程序的动态渲染" class="header-anchor">#</a> 1.2.3 加快小程序的动态渲染</h3> <h4 id="减少setdata传递的数据量"><a href="#减少setdata传递的数据量" class="header-anchor">#</a> 减少setData传递的数据量</h4> <ul><li>setData涉及到进程间的通信，尤其是Native向Web传递使用的是EvaluateScript的方式，过大的数据量，就需要更长的处理时间</li> <li>可以只传递data中变化的部分，也可以将多次setData合并为一次调用</li></ul> <h4 id="正确使用自定义组件"><a href="#正确使用自定义组件" class="header-anchor">#</a> 正确使用自定义组件</h4> <ul><li>如果无法避免的需要频繁更新某一部分渲染层的ui，可以将该部分声明为一个独立的自定义组件，因为这些组件内部的数据更新是独立的，计算开销更小</li> <li>去掉自定义组件不必要的dataset属性，因为每次时间触发时，这些数据都会被收集传递到逻辑层</li> <li>一个页面内自定义组件的数量也不宜过多，否则将会因为自定义组件的注册开销影响到首屏的渲染速度</li></ul> <h4 id="使用wxs"><a href="#使用wxs" class="header-anchor">#</a> 使用WXS</h4> <p>可以理解为：WXS就是直接运行于渲染层，也就是浏览器的脚本，所以存在一些能力和限制。</p> <ul><li>语法上只支持类似ES5的标准</li> <li>与逻辑层javascript作用域隔离</li> <li>可以通过调用组件实例的方法或者发出自定义事件来实现与逻辑层的间接通信</li> <li>可以直接获取或修改组件上元素的样式</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 导出变量pull</span>
<span class="token operator">&lt;</span>wxs module<span class="token operator">=</span><span class="token string">&quot;pull&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;./pull.wxs&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>scroll<span class="token operator">-</span>view
  <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;pulldown-wrapper&quot;</span>
  bindtouchstart<span class="token operator">=</span><span class="token string">&quot;{{pull.touchStart}}&quot;</span>
  bindtouchstart<span class="token operator">=</span><span class="token string">&quot;{{pull.touchMove}}&quot;</span>s
  bindtouchstart<span class="token operator">=</span><span class="token string">&quot;{{pull.touchEnd}}&quot;</span>
  change<span class="token operator">:</span>prop<span class="token operator">=</span><span class="token string">&quot;{{pull.monitorShowRefresh}}&quot;</span>
  prop<span class="token operator">=</span><span class="token string">&quot;{{showRefresh}}&quot;</span>
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>view<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>scroll<span class="token operator">-</span>view<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>wxs的通信方式</p> <p><img src="/assets/img/wechat-com.4564e44a.png" alt=""></p> <p>动态设置data到wxml上</p> <p><a href="https://developers.weixin.qq.com/miniprogram/dev/reference/wxs/" target="_blank" rel="noopener noreferrer">wxs传送门<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/13/2025, 7:45:34 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/engineering/tool.html" class="prev">效率工具</a></span> <span class="next"><a href="/projectPractice/isomorphism.html">认识同构及原理</a>
      →
    </span></p></div> </main> <footer class="footer" data-v-266a5a28><div class="container" data-v-266a5a28><p class="text-center" data-v-266a5a28>© 2024 web全栈体系. All Rights Reserved.（所有文章未经授权禁止转载、摘编、复制或建立镜像，如有违反，追究法律责任。）</p> <p class="text-center" data-v-266a5a28><a href="https://beian.miit.gov.cn" target="_blank" data-v-266a5a28>豫ICP备19041317号-1</a></p></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0f616eb6.js" defer></script><script src="/assets/js/3.9750fba5.js" defer></script><script src="/assets/js/2.6aa46093.js" defer></script><script src="/assets/js/21.56a0a87d.js" defer></script><script src="/assets/js/27.c05d3044.js" defer></script>
  </body>
</html>
