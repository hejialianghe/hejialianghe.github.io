<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>预习资料 | web全栈体系</title>
    <meta name="description" content="你好，朋友">
    <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.5718d53e.css" as="style"><link rel="preload" href="/assets/js/app.0f616eb6.js" as="script"><link rel="preload" href="/assets/js/3.9750fba5.js" as="script"><link rel="preload" href="/assets/js/2.6aa46093.js" as="script"><link rel="preload" href="/assets/js/5.e06ff02e.js" as="script"><link rel="preload" href="/assets/js/27.c05d3044.js" as="script"><link rel="prefetch" href="/assets/js/10.3b417cc7.js"><link rel="prefetch" href="/assets/js/100.450b51bc.js"><link rel="prefetch" href="/assets/js/101.02365136.js"><link rel="prefetch" href="/assets/js/102.23f6118f.js"><link rel="prefetch" href="/assets/js/103.4decf838.js"><link rel="prefetch" href="/assets/js/104.d39cfd73.js"><link rel="prefetch" href="/assets/js/105.88534338.js"><link rel="prefetch" href="/assets/js/106.366d0b59.js"><link rel="prefetch" href="/assets/js/107.cf3cfcba.js"><link rel="prefetch" href="/assets/js/108.21694919.js"><link rel="prefetch" href="/assets/js/109.4e4fd62e.js"><link rel="prefetch" href="/assets/js/11.9d20f01b.js"><link rel="prefetch" href="/assets/js/110.aeb394e4.js"><link rel="prefetch" href="/assets/js/111.d6595775.js"><link rel="prefetch" href="/assets/js/12.ac6dcc46.js"><link rel="prefetch" href="/assets/js/13.3990b71a.js"><link rel="prefetch" href="/assets/js/14.42418305.js"><link rel="prefetch" href="/assets/js/15.3e7fea41.js"><link rel="prefetch" href="/assets/js/16.e9242241.js"><link rel="prefetch" href="/assets/js/17.5cb2a82b.js"><link rel="prefetch" href="/assets/js/18.09a2ee08.js"><link rel="prefetch" href="/assets/js/19.5e018236.js"><link rel="prefetch" href="/assets/js/20.2f6aad81.js"><link rel="prefetch" href="/assets/js/21.56a0a87d.js"><link rel="prefetch" href="/assets/js/22.37a8fef4.js"><link rel="prefetch" href="/assets/js/23.75c65558.js"><link rel="prefetch" href="/assets/js/24.19255d9b.js"><link rel="prefetch" href="/assets/js/25.b96e970c.js"><link rel="prefetch" href="/assets/js/26.8043101d.js"><link rel="prefetch" href="/assets/js/28.c0aa90a2.js"><link rel="prefetch" href="/assets/js/29.06c0191d.js"><link rel="prefetch" href="/assets/js/30.975fb305.js"><link rel="prefetch" href="/assets/js/31.0cba5310.js"><link rel="prefetch" href="/assets/js/32.d8bc188f.js"><link rel="prefetch" href="/assets/js/33.384f6578.js"><link rel="prefetch" href="/assets/js/34.6baca6a7.js"><link rel="prefetch" href="/assets/js/35.96ec3f3e.js"><link rel="prefetch" href="/assets/js/36.bd945c36.js"><link rel="prefetch" href="/assets/js/37.be27655b.js"><link rel="prefetch" href="/assets/js/38.e8e93b37.js"><link rel="prefetch" href="/assets/js/39.ef88fac1.js"><link rel="prefetch" href="/assets/js/4.aa28cc69.js"><link rel="prefetch" href="/assets/js/40.b6dad60d.js"><link rel="prefetch" href="/assets/js/41.c762ef5a.js"><link rel="prefetch" href="/assets/js/42.151d8a58.js"><link rel="prefetch" href="/assets/js/43.632c642f.js"><link rel="prefetch" href="/assets/js/44.2e34b5d9.js"><link rel="prefetch" href="/assets/js/45.94f8db29.js"><link rel="prefetch" href="/assets/js/46.57527f8f.js"><link rel="prefetch" href="/assets/js/47.44a84132.js"><link rel="prefetch" href="/assets/js/48.66958018.js"><link rel="prefetch" href="/assets/js/49.21739b30.js"><link rel="prefetch" href="/assets/js/50.000c5d7c.js"><link rel="prefetch" href="/assets/js/51.b59a6470.js"><link rel="prefetch" href="/assets/js/52.3a475ad4.js"><link rel="prefetch" href="/assets/js/53.9801890b.js"><link rel="prefetch" href="/assets/js/54.269a45cd.js"><link rel="prefetch" href="/assets/js/55.91e89997.js"><link rel="prefetch" href="/assets/js/56.493b7ae8.js"><link rel="prefetch" href="/assets/js/57.ec46c27c.js"><link rel="prefetch" href="/assets/js/58.56202f8d.js"><link rel="prefetch" href="/assets/js/59.4dac8d8a.js"><link rel="prefetch" href="/assets/js/6.45a79ebc.js"><link rel="prefetch" href="/assets/js/60.77f7cd1f.js"><link rel="prefetch" href="/assets/js/61.a48bae63.js"><link rel="prefetch" href="/assets/js/62.626e88b6.js"><link rel="prefetch" href="/assets/js/63.9d36ed5d.js"><link rel="prefetch" href="/assets/js/64.a6a4e5c6.js"><link rel="prefetch" href="/assets/js/65.e32c3a18.js"><link rel="prefetch" href="/assets/js/66.0de20cc0.js"><link rel="prefetch" href="/assets/js/67.b24d4adf.js"><link rel="prefetch" href="/assets/js/68.7269173e.js"><link rel="prefetch" href="/assets/js/69.9999d01e.js"><link rel="prefetch" href="/assets/js/7.1a1f32a2.js"><link rel="prefetch" href="/assets/js/70.a45e1785.js"><link rel="prefetch" href="/assets/js/71.d443735d.js"><link rel="prefetch" href="/assets/js/72.56bd9ca0.js"><link rel="prefetch" href="/assets/js/73.4a484020.js"><link rel="prefetch" href="/assets/js/74.d0f77ba8.js"><link rel="prefetch" href="/assets/js/75.8595de75.js"><link rel="prefetch" href="/assets/js/76.b89309e6.js"><link rel="prefetch" href="/assets/js/77.1a28c952.js"><link rel="prefetch" href="/assets/js/78.156340fe.js"><link rel="prefetch" href="/assets/js/79.bc68f887.js"><link rel="prefetch" href="/assets/js/8.ffcc6d32.js"><link rel="prefetch" href="/assets/js/80.00742412.js"><link rel="prefetch" href="/assets/js/81.d07bf30f.js"><link rel="prefetch" href="/assets/js/82.dd648b4e.js"><link rel="prefetch" href="/assets/js/83.50310bd1.js"><link rel="prefetch" href="/assets/js/84.8b446b87.js"><link rel="prefetch" href="/assets/js/85.1bbf1222.js"><link rel="prefetch" href="/assets/js/86.b1112682.js"><link rel="prefetch" href="/assets/js/87.5353ad37.js"><link rel="prefetch" href="/assets/js/88.3bc7938a.js"><link rel="prefetch" href="/assets/js/89.c9d6877e.js"><link rel="prefetch" href="/assets/js/9.bfaf9c10.js"><link rel="prefetch" href="/assets/js/90.f7c20556.js"><link rel="prefetch" href="/assets/js/91.72437dd2.js"><link rel="prefetch" href="/assets/js/92.2a17869e.js"><link rel="prefetch" href="/assets/js/93.cc33ea11.js"><link rel="prefetch" href="/assets/js/94.49e5d122.js"><link rel="prefetch" href="/assets/js/95.9c954379.js"><link rel="prefetch" href="/assets/js/96.638e1dee.js"><link rel="prefetch" href="/assets/js/97.c2372908.js"><link rel="prefetch" href="/assets/js/98.762254ac.js"><link rel="prefetch" href="/assets/js/99.29af3121.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5718d53e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-266a5a28><header class="navbar" data-v-266a5a28><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="web全栈体系" class="logo"> <span class="site-name can-hide">web全栈体系</span></a> <div class="carousel" data-v-1a4d21d9></div> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><a href="https://github.com/hejialianghe" class="repo-star"><img src="https://img.shields.io/github/stars/hejialianghe/Senior-FrontEnd.svg?style=flat-square" alt></a> <div class="nav-item"><a href="/algorithm/complexity.html" class="nav-link">算法小册</a></div><div class="nav-item"><a href="/guide/" class="nav-link">web体系</a></div><div class="nav-item"><a href="/fp/react/build-react.html" class="nav-link">框架原理</a></div><div class="nav-item"><a href="https://github.com/hejialianghe/Senior-FrontEnd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee.com/hejialianghe/Senior-FrontEnd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="选择语言" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jsadvanced/asyncpro.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en-US/jsadvanced/asyncpro.html" class="nav-link">English</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-266a5a28></div> <aside class="sidebar" data-v-266a5a28><nav class="nav-links"><a href="https://github.com/hejialianghe" class="repo-star"><img src="https://img.shields.io/github/stars/hejialianghe/Senior-FrontEnd.svg?style=flat-square" alt></a> <div class="nav-item"><a href="/algorithm/complexity.html" class="nav-link">算法小册</a></div><div class="nav-item"><a href="/guide/" class="nav-link">web体系</a></div><div class="nav-item"><a href="/fp/react/build-react.html" class="nav-link">框架原理</a></div><div class="nav-item"><a href="https://github.com/hejialianghe/Senior-FrontEnd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee.com/hejialianghe/Senior-FrontEnd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="选择语言" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jsadvanced/asyncpro.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en-US/jsadvanced/asyncpro.html" class="nav-link">English</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" class="sidebar-link">介绍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JavaScript进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jsadvanced/" aria-current="page" class="sidebar-link">前言</a></li><li><a href="/jsadvanced/function.html" class="sidebar-link">函数</a></li><li><a href="/jsadvanced/asyncpro.html" aria-current="page" class="active sidebar-link">异步编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#预习资料" class="sidebar-link">预习资料</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#《3-1-理解异步》预习资料" class="sidebar-link">《3.1-理解异步》预习资料</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#《3-2-event-loop-机制》预习资料" class="sidebar-link">《3.2-Event Loop 机制》预习资料</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-3-异步编程方法-发布-订阅》拓展学习资料" class="sidebar-link">3.3-异步编程方法-发布/订阅》拓展学习资料</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#《3-4-深入理解-promise》预习资料" class="sidebar-link">《3.4-深入理解 promise》预习资料</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#《3-5-generator-函数及其异步的应用》预习资料" class="sidebar-link">《3.5-Generator 函数及其异步的应用》预习资料</a></li></ul></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-1-理解异步" class="sidebar-link">3.1 理解异步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-1-1-同步与异步" class="sidebar-link">3.1.1 同步与异步</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-1-2-javascript-单线程" class="sidebar-link">3.1.2 javaScript 单线程</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-1-3-定时器" class="sidebar-link">3.1.3 定时器</a></li></ul></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-2-event-loop-机制" class="sidebar-link">3.2 Event Loop 机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-2-1-浏览器的-event-loop" class="sidebar-link">3.2.1 浏览器的 Event Loop</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-2-2-node-js-的-event-loop" class="sidebar-link">3.2.2 node.js 的 Event Loop</a></li></ul></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-3-异步编程方法-发布-订阅" class="sidebar-link">3.3 异步编程方法-发布/订阅</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-3-1-理解发布-订阅" class="sidebar-link">3.3.1 理解发布/订阅</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-3-2-实现事件发布-订阅" class="sidebar-link">3.3.2 实现事件发布/订阅</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-3-3-node-js-的发布-订阅" class="sidebar-link">3.3.3 node.js 的发布/订阅</a></li></ul></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-4-深入理解-promise" class="sidebar-link">3.4 深入理解 promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-4-1-promise-a-规范" class="sidebar-link">3.4.1 promise A+规范</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-4-2-es6-promise-api" class="sidebar-link">3.4.2 ES6 Promise API</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-4-3-promise-实践" class="sidebar-link">3.4.3 promise 实践</a></li></ul></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-5-generator-函数及其异步的应用" class="sidebar-link">3.5 Generator 函数及其异步的应用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-5-1-generator-函数" class="sidebar-link">3.5.1 Generator 函数</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-5-2-thunk-函数" class="sidebar-link">3.5.2 Thunk 函数</a></li></ul></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-6-深入理解-async-await" class="sidebar-link">3.6 深入理解 async/await</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-6-1-async-函数" class="sidebar-link">3.6.1 async 函数</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-6-2-应用" class="sidebar-link">3.6.2 应用</a></li></ul></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-7-手写-promise" class="sidebar-link">3.7 手写 Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-7-1-先实现整体结构" class="sidebar-link">3.7.1 先实现整体结构</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-7-2-实现-promise-内部的-resolve-和-reject" class="sidebar-link">3.7.2 实现 Promise 内部的 resolve 和 reject</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-7-3-实现-promise-原型上的-then-方法" class="sidebar-link">3.7.3 实现 Promise 原型上的 then 方法</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-7-4-实现-promsie-原型的-catch-方法" class="sidebar-link">3.7.4 实现 promsie 原型的 catch 方法</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-7-5-promise-resolve" class="sidebar-link">3.7.5 Promise.resolve</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-7-6-promise-reject" class="sidebar-link">3.7.6 Promise.reject</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-7-7-promise-all" class="sidebar-link">3.7.7 Promise.all</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-7-8-promise-race" class="sidebar-link">3.7.8 Promise.race</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-7-9-总结" class="sidebar-link">3.7.9 总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-8-web-workers-的多线程机制" class="sidebar-link">3.8 Web Workers 的多线程机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-8-1-web-workers-介绍" class="sidebar-link">3.8.1 Web Workers 介绍</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-8-2-实战一个-web-worker-的案例" class="sidebar-link">3.8.2 实战一个 web worker 的案例</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-8-3-worker-的能力是受限制的" class="sidebar-link">3.8.3 worker 的能力是受限制的</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-8-4-web-worker-的使用场景" class="sidebar-link">3.8.4 Web Worker 的使用场景</a></li></ul></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-9-service-workers" class="sidebar-link">3.9 Service Workers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-9-1-初识-service-workers" class="sidebar-link">3.9.1 初识 Service Workers</a></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#_3-9-1-小试牛刀" class="sidebar-link">3.9.1 小试牛刀</a></li></ul></li><li class="sidebar-sub-header"><a href="/jsadvanced/asyncpro.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/jsadvanced/designpattern.html" class="sidebar-link">设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>计算机网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/computerNetwork/protocal.html" class="sidebar-link">网络协议</a></li><li><a href="/computerNetwork/network-actual.html" class="sidebar-link">网络请求实战</a></li><li><a href="/computerNetwork/security.html" class="sidebar-link">网络安全与攻防</a></li><li><a href="/computerNetwork/browser-status.html" class="sidebar-link">浏览器状态同步和路由</a></li><li><a href="/computerNetwork/tools.html" class="sidebar-link">工具链和其他</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/" class="sidebar-link">前言</a></li><li><a href="/vue/vueBase.html" class="sidebar-link">vue基础</a></li><li><a href="/vue/vueComponents.html" class="sidebar-link">探索vue的组件世界</a></li><li><a href="/vue/sourceCode.html" class="sidebar-link">部分源码解析</a></li><li><a href="/vue/serverSideRender.html" class="sidebar-link">服务端渲染</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>react</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/" class="sidebar-link">入门介绍</a></li><li><a href="/react/react-base.html" class="sidebar-link">步入react</a></li><li><a href="/react/react-positive.html" class="sidebar-link">react正篇</a></li><li><a href="/react/react-ecology.html" class="sidebar-link">react生态</a></li><li><a href="/react/react-principle.html" class="sidebar-link">react原理</a></li><li><a href="/react/react-state-mana.html" class="sidebar-link">react状态管理</a></li><li><a href="/react/react-actualCombat.html" class="sidebar-link">react高级实战</a></li><li><a href="/react/react-hooks.html" class="sidebar-link">react-hooks</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Node.js进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node/" class="sidebar-link">Node.js基础</a></li><li><a href="/node/koa.html" class="sidebar-link">koa</a></li><li><a href="/node/egg.html" class="sidebar-link">企业级框架egg</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工程化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/engineering/script.html" class="sidebar-link">脚本世界</a></li><li><a href="/engineering/coding-standards.html" class="sidebar-link">规范先行</a></li><li><a href="/engineering/quality-code.html" class="sidebar-link">质量代码</a></li><li><a href="/engineering/design.html" class="sidebar-link">工程设计</a></li><li><a href="/engineering/ctg-art.html" class="sidebar-link">构建艺术</a></li><li><a href="/engineering/auto-deploy.html" class="sidebar-link">持续集成与部署</a></li><li><a href="/engineering/git.html" class="sidebar-link">Git操作</a></li><li><a href="/engineering/tool.html" class="sidebar-link">效率工具</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>小程序</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/applets/performance.html" class="sidebar-link">小程序进阶</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>项目实战</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/projectPractice/isomorphism.html" class="sidebar-link">认识同构及原理</a></li><li><a href="/projectPractice/demo.html" class="sidebar-link">实现一个同构的demo</a></li><li><a href="/projectPractice/nextjs.html" class="sidebar-link">Nextjs</a></li></ul></section></li></ul> </aside> <main class="page" data-v-266a5a28> <div class="ads" data-v-a4c8d602><div class="item" data-v-a4c8d602><h6 class="title" style="display:;" data-v-a4c8d602>联系作者</h6> <div class="thumb" data-v-a4c8d602><a href="/weixin.jpeg" target="_blank" data-v-a4c8d602><img src="/weixin.jpeg" alt="联系作者" data-v-a4c8d602></a></div></div></div> <div class="theme-default-content content__default"><h2 id="预习资料"><a href="#预习资料" class="header-anchor">#</a> 预习资料</h2> <h3 id="《3-1-理解异步》预习资料"><a href="#《3-1-理解异步》预习资料" class="header-anchor">#</a> 《3.1-理解异步》预习资料</h3> <table><thead><tr><th style="text-align:center;">预习资料名称</th> <th style="text-align:center;">链接</th> <th style="text-align:center;">备注</th></tr></thead> <tbody><tr><td style="text-align:center;">官方图解：Chrome 快是有原因的，现代浏览器的多进程架构！</td> <td style="text-align:center;"><a href="https://juejin.im/post/5bd7c761518825292d6b0217" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">学习这篇文章可以了解浏览器的架构以及每个模块负责的工作，宏观上了解浏览器的工作原理。</td></tr> <tr><td style="text-align:center;">进程与线程的一个简单解释</td> <td style="text-align:center;"><a href="https://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">文章生动形象的比喻了进程和线程，将抽象的概念形象化了</td></tr> <tr><td style="text-align:center;">浏览器进程？线程？傻傻分不清楚</td> <td style="text-align:center;"><a href="https://imweb.io/topic/58e3bfa845e5c13468f567d5" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">文重点讲解线程、进程的区别，以及浏览器内核的多线程</td></tr> <tr><td style="text-align:center;">定时器标准</td> <td style="text-align:center;"><a href="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">规范对定时器的说明</td></tr></tbody></table> <h3 id="《3-2-event-loop-机制》预习资料"><a href="#《3-2-event-loop-机制》预习资料" class="header-anchor">#</a> 《3.2-Event Loop 机制》预习资料</h3> <table><thead><tr><th style="text-align:center;">预习资料名称</th> <th style="text-align:center;">链接</th> <th style="text-align:center;">备注</th></tr></thead> <tbody><tr><td style="text-align:center;">Event Loops 标准</td> <td style="text-align:center;"><a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loops" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">标准对 Event Loops 的说明</td></tr> <tr><td style="text-align:center;">Node.js 事件循环，定时器和 process.nextTick()</td> <td style="text-align:center;"><a href="https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/#what-is-the-event-loop" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">介绍了 nodejs 的事件循环和定时器</td></tr> <tr><td style="text-align:center;">调用栈</td> <td style="text-align:center;"><a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Call_stack" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">介绍 js 运行调用栈</td></tr> <tr><td style="text-align:center;">JS 中的栈内存堆内存</td> <td style="text-align:center;"><a href="https://juejin.im/post/5d116a9df265da1bb47d717b" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">---</td></tr></tbody></table> <h3 id="_3-3-异步编程方法-发布-订阅》拓展学习资料"><a href="#_3-3-异步编程方法-发布-订阅》拓展学习资料" class="header-anchor">#</a> 3.3-异步编程方法-发布/订阅》拓展学习资料</h3> <table><thead><tr><th style="text-align:center;">预习资料名称</th> <th style="text-align:center;">链接</th> <th style="text-align:center;">备注</th></tr></thead> <tbody><tr><td style="text-align:center;">EventEmitter 实现源码</td> <td style="text-align:center;"><a href="https://github.com/nodejs/node/blob/master/lib/events.js" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">阅读文档后在看</td></tr> <tr><td style="text-align:center;">FsWatch 实现源码</td> <td style="text-align:center;"><a href="https://github.com/nodejs/node/blob/master/lib/internal/fs/watchers.js" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">阅读文档后在看</td></tr></tbody></table> <h3 id="《3-4-深入理解-promise》预习资料"><a href="#《3-4-深入理解-promise》预习资料" class="header-anchor">#</a> 《3.4-深入理解 promise》预习资料</h3> <table><thead><tr><th style="text-align:center;">预习资料名称</th> <th style="text-align:center;">链接</th> <th style="text-align:center;">备注</th></tr></thead> <tbody><tr><td style="text-align:center;">promise 基础</td> <td style="text-align:center;"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">---</td></tr> <tr><td style="text-align:center;">promises A+规范</td> <td style="text-align:center;"><a href="https://github.com/promises-aplus/promises-spec" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">---</td></tr> <tr><td style="text-align:center;">promises A+规范测试工具用例工具</td> <td style="text-align:center;"><a href="https://github.com/promises-aplus/promises-tests" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">---</td></tr></tbody></table> <h3 id="《3-5-generator-函数及其异步的应用》预习资料"><a href="#《3-5-generator-函数及其异步的应用》预习资料" class="header-anchor">#</a> 《3.5-Generator 函数及其异步的应用》预习资料</h3> <table><thead><tr><th style="text-align:center;">预习资料名称</th> <th style="text-align:center;">链接</th> <th style="text-align:center;">备注</th></tr></thead> <tbody><tr><td style="text-align:center;">可迭代协议 迭代器协议</td> <td style="text-align:center;"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Iteration_protocols#%E5%8F%AF%E8%BF%AD%E4%BB%A3%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">介绍可迭代协议和迭代器协议</td></tr> <tr><td style="text-align:center;">协程</td> <td style="text-align:center;"><a href="https://cnodejs.org/topic/58ddd7a303d476b42d34c911" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">介绍协程</td></tr> <tr><td style="text-align:center;">co 源码</td> <td style="text-align:center;"><a href="https://github.com/tj/co" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">分析源码</td></tr></tbody></table> <h2 id="_3-1-理解异步"><a href="#_3-1-理解异步" class="header-anchor">#</a> 3.1 理解异步</h2> <h3 id="_3-1-1-同步与异步"><a href="#_3-1-1-同步与异步" class="header-anchor">#</a> 3.1.1 同步与异步</h3> <h4 id="先看-2-段代码"><a href="#先看-2-段代码" class="header-anchor">#</a> 🍅 先看 2 段代码</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//代码1</span>
<span class="token keyword">const</span> <span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t <span class="token operator">&gt;=</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment">// 执行结果 1 2 3</span>

<span class="token comment">// 代码2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token comment">// 执行结果 1 3 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>代码 1 都是同步任务，代码 2 有异步任务 setTimeout；所有执行结果不同</p> <p><font color="red"><strong>同步</strong></font>：主线程上排队执行的任务，只有前面的任务执行完，才能执行后面的任务</p> <p><font color="red"><strong>异步</strong></font>：是指不进入主线程，而是进入<code>任务队列</code>的任务,只有<code>任务队列</code>通知主线程，某个
任务可以执行了，该任务才会进入主线程执行</p> <h4 id="单线程的-js-怎么实现异步"><a href="#单线程的-js-怎么实现异步" class="header-anchor">#</a> 🍅 单线程的 js 怎么实现异步？</h4> <p>如果按照 js 是单线程的，上面的代码 2 应该是 123 才符合单线程的表现；现在为什么是 132 呢，那异步怎么实现的呢？</p> <h4 id="学习异步之前先了解一下什么是进程-什么是线程"><a href="#学习异步之前先了解一下什么是进程-什么是线程" class="header-anchor">#</a> 🍅 学习异步之前先了解一下什么是进程？什么是线程？</h4> <p><img src="/assets/img/proandthr.18a0444f.png" alt="">
打个比方：假如 cpu 是一个工厂，进程就是一个车间；线程就是工人，一个进程有多个线程，它们之间资源共享，也就内存空间共享。</p> <p>linux 下 查看进程：</p> <p>ps (process status) 列出系统中当前运行进程的快照</p> <p>top (table of processes) 动态实时查看进程</p> <p>kill 9 进程 pid 杀死进程</p> <h4 id="回答单线程的-js-怎么实现异步"><a href="#回答单线程的-js-怎么实现异步" class="header-anchor">#</a> 🍅 回答单线程的 js 怎么实现异步？</h4> <p>通过浏览器的内核多线程实现异步</p> <h3 id="_3-1-2-javascript-单线程"><a href="#_3-1-2-javascript-单线程" class="header-anchor">#</a> 3.1.2 javaScript 单线程</h3> <h4 id="浏览器是一个多进程的架构"><a href="#浏览器是一个多进程的架构" class="header-anchor">#</a> 🍅 浏览器是一个多进程的架构</h4> <p>我们打开一个浏览器就会启动以下进程，我们所要关心的是渲染进程，渲染进程是浏览器的核心进程
<img src="/assets/img/singlethread.2a5293b2.png" alt=""></p> <h4 id="渲染进程下的多线程"><a href="#渲染进程下的多线程" class="header-anchor">#</a> 🍅 渲染进程下的多线程</h4> <p><img src="/assets/img/multithreading.78bac587.png" alt=""> <font color="red"><strong>GUI 线程</strong></font>：负责渲染页面，解析 html、css；构建 DOM 树和渲染树</p> <p><font color="red"><strong>js 引擎线程</strong></font>： js 引擎线程负责解析和执行 js 程序，我们经常听到的 chrome 的 v8 引擎就是跑在 js 引擎线程上的，js 引擎线程只有一个，所有说 js 的单线程语言的原因，那其实语言没有单线程多线程之说，因为解释这个语言的是
的线程是单线程；js 引擎线程与 gui 线程互斥，当浏览器执行 javaScript 程序的时候，GUI 渲染线层会保存在一个队列当中；直到 js 程序执行完成，才会接着执行；如果 js 的执行时间过长，会影响页面的渲染不连贯，所有我们要尽量控制 js 的大小</p> <p><font color="red"><strong>定时触发线程</strong></font>：为什么 setTimeout 不阻塞后面程序的运行，那其实 setTimeout 不是由 js 引擎线程完成的，是由定时器触发线程完成的，所以它们可以是同时进行的，那么定时器触发线程在这定时任务完成之后会通知事件触发线程往任务队列里添加事件</p> <p><font color="red"><strong>事件触发线程</strong></font>：将满足触发条件的事件放入任务队列，一些异步的事件会放到异步队列中</p> <p><font color="red"><strong>异步 HTTP 请求线程</strong></font>：用与处理 ajax 请求的，当请求完成时如果有回调函数就通知事件触发线程往任务队列中添加任务</p> <h4 id="异步场景"><a href="#异步场景" class="header-anchor">#</a> 🍅 异步场景</h4> <ol><li>定时器</li> <li>网络请求</li> <li>事件绑定</li> <li>ES6 Promise</li></ol> <h3 id="_3-1-3-定时器"><a href="#_3-1-3-定时器" class="header-anchor">#</a> 3.1.3 定时器</h3> <h4 id="定时器的执行过程"><a href="#定时器的执行过程" class="header-anchor">#</a> 🍅 定时器的执行过程</h4> <p>代码在执行栈中执行，然后 1=&gt;2=&gt;3=&gt;4</p> <p><img src="/assets/img/asynctask.c271c6a7.png" alt=""></p> <h4 id="定时器示例"><a href="#定时器示例" class="header-anchor">#</a> 🍅 定时器示例</h4> <p><img src="/assets/img/asynctaskele.3a2bbc72.png" alt=""></p> <p><font color="red"><strong>执行过程解释</strong></font>：</p> <ol><li><code>console.log(1)</code>先入栈执行，执行完出栈</li> <li>遇到<code>setTimeout</code> 调用 setTimeout 这个 webapi，通知定时触发线程定时 2 秒钟</li> <li><code>console.log(3)</code>入栈执行，执行完出栈</li> <li>栈中已经空了，去检查任务队列，此时还为到 2 秒钟，任务队列中还没有任务；这是一个循环检查的过程，等到 2 秒钟后
事件触发线程往任务队列中添加了定时器的事件，这时候再去检查的时候已经有了定时器的异步任务，我们取出这个任务放到执行栈中执行，这时候打印出了 2</li></ol> <h4 id="定时器会带来的问题"><a href="#定时器会带来的问题" class="header-anchor">#</a> 🍅 定时器会带来的问题</h4> <ol><li>定时任务可能不能按时执行</li></ol> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t <span class="token operator">&gt;=</span> <span class="token number">5000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 等到5秒钟后才打印出了2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>为什么呢？</p> <p>因为 test 是会耗时 5 秒钟的同步任务，异步任务只能等待同步任务执行完之后才能执行，也就是说只能等 5 秒钟后才能检查的任务队列里的任务。</p> <ol start="2"><li>定时器嵌套 5 次之后最小间隔不能低于 4ms</li></ol> <h4 id="定时器的应用场景"><a href="#定时器的应用场景" class="header-anchor">#</a> 🍅 定时器的应用场景</h4> <ol><li>防抖节流</li> <li>到计时</li> <li>动画 （有丢帧问题）</li></ol> <h2 id="_3-2-event-loop-机制"><a href="#_3-2-event-loop-机制" class="header-anchor">#</a> 3.2 Event Loop 机制</h2> <p>以前 js 是在浏览器环境中运行，由于 chrome 对 v8 做了开源；所以 js 有机会在服务端运行；浏览器和 node 都是 js 的运行环境，它们相当于是一个宿主，宿主能提供一个能力能帮助 js 实现 Event Loop</p> <h4 id="js-单线程问题"><a href="#js-单线程问题" class="header-anchor">#</a> 🍅 js 单线程问题</h4> <p>所有任务都在一个线程上完成，一旦遇到大量任务或遇到一个耗时的任务，网页就可能出现假死，也无法响应用户的行为</p> <h4 id="event-loop-是什么"><a href="#event-loop-是什么" class="header-anchor">#</a> 🍅 Event Loop 是什么</h4> <p>Event Loop 是一个程序结构，用于等待和发送信息的事件。
简单说就是在程序中设置 2 个线程，一个负责程序本身的运行，称为“主线程”；另一个负责主线程和其他进程（主要是各种 I/O 操作）的通信
被称为“Event Loop 线程”（也可以翻译为消息线层）</p> <p>js 就是采用了这种机制，来解决单线程带来的问题。</p> <h3 id="_3-2-1-浏览器的-event-loop"><a href="#_3-2-1-浏览器的-event-loop" class="header-anchor">#</a> 3.2.1 浏览器的 Event Loop</h3> <h4 id="异步实现"><a href="#异步实现" class="header-anchor">#</a> 🍅 异步实现</h4> <ol><li>宏观：浏览器多线程（从宏观来看是多线程实现了异步）</li> <li>微观：Event Loop，事件循环（Event Loop 翻译是事件循环，是实现异步的一种机制）</li></ol> <h4 id="先看一个例子"><a href="#先看一个例子" class="header-anchor">#</a> 🍅 先看一个例子</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token comment">// 1 4 3 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="/assets/img/eventlooptest1.de5142cd.png" alt="">
1 和 4 是同步任务肯定是最先执行，现在要看异步任务，现在要看的是<code>promise</code>的回调为什么在定时器前面执行，那为什么<code>promise</code>后放入，为什么先执行呢？那是因为 Event Loop 的机制是有微任务的说法的；现在往下看。</p> <h4 id="宏任务-普通任务-和微任务"><a href="#宏任务-普通任务-和微任务" class="header-anchor">#</a> 🍅 宏任务（普通任务）和微任务</h4> <p><img src="/assets/img/taskandmicrotask.be11fa1f.png" alt=""> <font color="red"><strong>宏任务（task）</strong></font>：</p> <ol><li>script：script 整体代码</li> <li>setImmediate：node 的一个方法</li> <li>setTimeout 和 setInterval</li> <li>requestAnimationFrame</li> <li>I/O</li> <li>UI rendering</li></ol> <p>......</p> <p><font color="red"><strong>微任务（microtask）</strong></font>：</p> <ol><li>Object.observe:监听对象变化的一个方法</li> <li>MutationObserver:可以监听 Dom 结构变化的一个 api</li> <li>postMessgae:window 对象通信的一个方法</li> <li>Promise.then catch finally</li></ol> <h4 id="event-loop-的运行过程"><a href="#event-loop-的运行过程" class="header-anchor">#</a> 🍅 Event Loop 的运行过程</h4> <p><img src="/assets/img/eventloopfn.0c0cd20c.png" alt="">
线程都有自己的数据存储空间，上图可以看见<code>堆</code>和<code>栈</code>，堆的空间比较大，所以存储一些对象；栈的空间比较小，
所以存储一些基础数据类型、对象的引用、函数的调用；函数调用就入栈，执行完函数体里的代码就自动从栈中移除这个函数，这就是我们所说的调用栈；
栈是一个先进后出的数据结构，当最里面的函数出栈的时候，这个栈就空了；当我们调用时候会调用一些异步函数，
这个异步函数会找他们的异步处理模块，这个异步模块包括定时器、promise、ajax 等，异步处理模块会找它们各自
对应的线程，线程向任务队列中添加事件，看我们的蓝色箭头，表示在任务队列中添加事件，橘色的箭头是从任务队列中取事件，取出这个事件去执行对应的回调函数；</p> <p>有 3 个点要注意</p> <ol><li>我们整个大的 script 的执行是全局任务也是一个宏任务的范畴，</li> <li>当宏任务执行完，会去执行所有的微任务，</li> <li>微任务全部执行完在去执行下一个宏任务，那什么时候去执行一个微任务呢，是等调用栈为空的时候，
调用栈不为空的时候，任务队列的微任务一直等待；微任务执行完又去取任务队列里的宏任务，去依次
执行宏任务，执行宏任务的时候就要检查当前有没有微任务，如果有微任务就去执行完所有微任务，然后
再去执行后续的宏任务</li></ol> <h4 id="代码示例-1"><a href="#代码示例-1" class="header-anchor">#</a> 🍅 代码示例 1</h4> <p><img src="/assets/img/eventlooptest2.1bb3ca2b.png" alt=""></p> <p><font color="red"><strong>执行步骤</strong></font>：</p> <ol><li>大的 script 是个宏任务，检查任务队列是否为空，当前不为空，然后执行 1 和 8 行代码；那么打印出了 1 和 4</li> <li>执行完 1 和 8 行代码后去检查微任务队列，微任务队列不为空，执行了 Promise 的回调，此时打印出了 3</li> <li>执行完 Promise 的回调后，在检查微任务队列，现在微任务队列为空，进行重新渲染一便</li> <li>在去检查任务队列，现在任务队列中有了定时器的事件，又打印出了 2</li></ol> <p><font color="red"><strong>注意点</strong></font>：</p> <ol><li>一个 Event Loop 有一个或多个 task queue（任务队列）</li> <li>每个个 Event Loop 有一个 microtask queue（微任务队列）</li> <li>requestAnimationFrame 不在任务队列也不在为任务队列，是在渲染阶段执行的</li> <li>任务需要多次事件循环才能执行完，微任务是一次性执行完的</li> <li>主程序和和 settimeout 都是宏任务，一个 promise 是微任务，第一个宏任务（主程序）执行完，执行全部的微任务（一个 promise），再执行下一个宏任务（settimeout）</li></ol> <h4 id="代码示例-2"><a href="#代码示例-2" class="header-anchor">#</a> 🍅 代码示例 2</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise inner1'</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise then1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise inner2'</span><span class="token punctuation">)</span> <span class="token comment">//同步执行的</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise then2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 打应结果</span>
<span class="token comment">/*
    start
    promise inner2
    promise then2
    setTimeout
    promise inner1
    promise then1
   */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="代码示例-3"><a href="#代码示例-3" class="header-anchor">#</a> 🍅 代码示例 3</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 start'</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2 promise'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/*
       start
       async1 start
       promise1
       async2 promise
       promise2
       async1 end
       setTimeout
   */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p><font color="red"><strong>执行步骤</strong></font>：</p> <ol><li><p>先执行主线程的同步任务（也是宏任务), 先执行<code>start</code>然后遇到了 setTimeout，把它放到下一次宏任务中执行，我们叫它宏 2；然后调用 async1()函数，执行了<code>async1 start</code>；又调用了 async2 函数执行 Promise.resolve().then；由于 then 的回调函数是微任务，就把它放到微任务队列中，我们叫它微 1；遇见 await 是等待的意思，需要把第一轮的微任务执行完，在执行 await 下面的内容，我们在执行 new Promise(),打印了<code>promise1</code>,又调用了 resolve()改变了 promise 状态，这个 then 的回调我们叫它微 2；第一轮宏任务执行完毕。</p></li> <li><p>第一轮宏热任务执行完毕后，我们检查微任务队列中的微任务，把它全部执行完，就打印了<code>async2 promise</code>、<code>promise2</code></p></li> <li><p>第一轮微任务执行完，就执行 await 后面的内容<code>async1 end</code></p></li> <li><p>await 后面的内容执行完后又执行宏任务<code>setTimeout</code></p></li></ol> <h4 id="代码示例-4"><a href="#代码示例-4" class="header-anchor">#</a> 🍅 代码示例 4</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">r</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">r</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/*
1
2
3
4
5
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><ol><li>先执行 script 代码，遇到第一个 setTimeout，放到宏任务队列中我们叫它宏 1，遇到第二个 setTimeout，放到宏任务队列中我们叫它宏 2。</li> <li>检查微任务队列中有无任务，有就全部执行，本次宏任务下没有产生微任务，没有就拿出宏 1 进行执行，执行宏 1 打印<code>1</code>；然后遇到 promise 就把 then 的回调放到微任务队列；宏 1 执行完以后，就去检查微任务队列中有任务么，有就全部执行，所以我们就执行了 2，在 then 的回调中又产生了微任务，所以我们又执行了 3，<font color="red">记住一点，要把本次宏任务下所产生的微任务全部执行完才会执行下一个宏任务，记住是产生的，没有产生的不会执行。</font></li> <li>一轮宏任务执行完以后，再去执行下一个宏任务，就会去执行宏 2，就打印了 4，在检查有没有产生了微任务，如果微任务队列中有微任务就全部执行，有微任务所以打印了 5。</li></ol> <h3 id="_3-2-2-node-js-的-event-loop"><a href="#_3-2-2-node-js-的-event-loop" class="header-anchor">#</a> 3.2.2 node.js 的 Event Loop</h3> <h4 id="node-js-架构图"><a href="#node-js-架构图" class="header-anchor">#</a> 🍅 node.js 架构图</h4> <p><img src="/assets/img/nodeframework.9a45e493.png" alt=""> <font color="red"><strong>有 3 层组成</strong></font></p> <ol><li>第一层：node-core 是 node.js api 的核心库。</li> <li>第二层：包装和暴露 libuv 和 js 的其他低级功能。</li> <li>第三层：v8 和 libuv 这个库属于第三层的东西，v8 引擎是 chrome 开源的 js 引擎，也是 js 运行服务端的基础，libuv 是第三方的库，是 nodejs 异步编程的基础，是 node 底层的 IO 引擎，是 c 语言编写的事件驱动的库；负责 node api 的执行，它会将不通的任务分配给不同的线程，从而形成了 Event Loop 事件循环；它以异步的方式将任务的执行结果返回给 v8 引擎；那我们说 node 是非阻塞 IO 单线程，实现这个非阻塞的原因就在与 libuv 这个库，node.js 的 Event Loop 都是这个库实现的。</li></ol> <h4 id="node-js-的-event-loop"><a href="#node-js-的-event-loop" class="header-anchor">#</a> 🍅 node.js 的 Event Loop</h4> <p><img src="/assets/img/nodeeventloop.2fec8a81.png" alt=""> <font color="red"><strong>执行的几个阶段</strong></font></p> <ol><li><font color="blue"><strong>timers 阶段：执行 timers 的回调，也是执行 setTimeout 和 setInterval 的回调</strong></font></li> <li>pending IO callbacks：系统操作的回调</li> <li>idle，pepare：内部使用</li> <li><font color="blue"><strong>poll：等待新的 I/O 事件进来</strong></font></li> <li><font color="blue"><strong>check：执行 setImmediate 回调</strong></font></li> <li>close callbacks：内部使用</li></ol> <p><font color="red"><strong>只需关注 1、4、5 阶段</strong></font></p> <p><font color="blue">每个阶段都有一个 callbacks 的先进先出的队列需要执行，当 event loop 运行到一个指定阶段时，该阶段的
fifo 队列将会被执行，当队列 callback 执行完或者执行的 callbacks 数量超过该阶段的上限时，event loop 会转入下一个阶段。
</font></p> <h4 id="poll-阶段"><a href="#poll-阶段" class="header-anchor">#</a> 🍅 poll 阶段</h4> <p><img src="/assets/img/poll.3942d235.png" alt=""></p> <p>Poll 阶段主要有 2 个功能：</p> <ol><li>计算应该被 block 多久（等待 IO 的操作）</li> <li>处理 poll 队列的事件
<ul><li>. 先判断 poll 队列是否空或受到限制，否的话执行 poll 队列的 callback；循环执行，直到空为止；或者到了限制。</li> <li>. 如果 poll 队列是空而且受到限制，检查<code>setImmedidate</code>有没有设置 callback，如果有设置就进入 check 阶段；如果没有设置 callback，就等待 callback 加入 poll 队列，如果这时候有 callback 加入到 poll 队列，那么这时又进入的 poll 队列；在 poll 阶段空闲的时候，Event loop 会检查 timer（定时器）是否到时间；假如到时间了，又 🈶️ 对应的 callback，那么它就会进去 timer 阶段；如果没到时间还是等待 callback 加入 poll 队列。</li></ul></li></ol> <h4 id="案例-1"><a href="#案例-1" class="header-anchor">#</a> 🍅 案例 1</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">someAsyncOperation</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// nodejs 一般没有加sync都是异步的</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> timeoutScheduled <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> delay <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> timeoutScheduled
  <span class="token comment">// 计算多延迟多少毫秒打印这一句</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>delay<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms have passed since I was scheduled</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>

<span class="token function">someAsyncOperation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> startCallback <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startCallback <span class="token operator">&lt;</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do nothing</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 打印结果 202ms have passed since I was scheduled</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ol><li>读文件进入<code>poll</code>阶段，然后进入会回调，读文件一般会需要几毫秒，在回调了我们使用了 while 循环；
延迟了 200 毫秒</li> <li>执行完 poll 队列，现在是空闲状态，检查有没有到时间的定时器；然后有 setTimeout，就执行了 setTimeout 的回调</li></ol> <h4 id="案例-2"><a href="#案例-2" class="header-anchor">#</a> 🍅 案例 2</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/*
  打印结果 setImmediate
          setTimeout
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以根据<code>poll阶段</code>的图来看，check 阶段比 timer 阶段先执行，执行到读取文件的回调时，先看是否设置了 setImmediate 的回调，如果有就进去 check 阶段，在等待 callbakc 加入 poll 队列空闲的时候才会检测是否有 timer；所以<code>setImmediate</code>比<code>setTimeout</code>先执行</p> <h4 id="process-nexttick"><a href="#process-nexttick" class="header-anchor">#</a> 🍅 process.nextTick()</h4> <p><code>process</code>进程的意思，process.nextTick()是一个异步的 node API，但不属于 event loop 的阶段，它的作用是当调用这个方法的时候，event loop 会先停下来，先执行这个方法的回调</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick2'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/*
 打印结果 nextTick1
         setImmediate
         nextTick2
         setTimeout
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ol><li>首先<code>fs.readFile</code>的回调加入 poll 队列，进入 poll 阶段，poll 阶段会看<code>setimmediate</code>有没有设置 callback，如果没有<code>process.nextTick()</code>，其实先打印<code>setimmediate</code>的回调，但是遇到<code>process.nextTick()</code>会暂停 event loop，先打印其回调。</li> <li>打印<code>process.nextTick()</code>回调之后，会进入<code>setimmediate</code>的 check 阶段，然后打印 setImmediate，然后又遇到<code>process.nextTick()</code>先停下来，又打印了 nextTick2。</li> <li>在检测有没有到时的定时器，然后进入 timer 阶段，打印了 setTimeout。</li></ol> <h4 id="案例-3"><a href="#案例-3" class="header-anchor">#</a> 🍅 案例 3</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token number">7</span>
<span class="token number">6</span>
<span class="token number">8</span>
<span class="token number">2</span>
<span class="token number">4</span>
<span class="token number">3</span>
<span class="token number">5</span>
<span class="token number">9</span>
<span class="token number">11</span>
<span class="token number">10</span>
<span class="token number">12</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>process.nextTick 优先于其他微任务的执行</p> <h4 id="settimeout-对比-setimmediate"><a href="#settimeout-对比-setimmediate" class="header-anchor">#</a> setTimeout 对比 setImmediate</h4> <ul><li>setTimeout(fn, 0)在 Timers 阶段执行，并且是在 poll 阶段进行判断是否达到指定的 timer 时间才会执行</li> <li>setImmediate(fn)在 Check 阶段执行</li></ul> <p><font color="red"><strong>两者的执行顺序要根据当前的执行环境才能确定：</strong></font></p> <p>如果两者都在主模块(main module)调用，那么执行先后取决于进程性能，顺序随机
如果两者都不在主模块调用，即在一个 I/O Circle 中调用，那么 setImmediate 的回调永远先执行，因为会先到 Check 阶段</p> <h4 id="setimmediate-对比-process-nexttick"><a href="#setimmediate-对比-process-nexttick" class="header-anchor">#</a> setImmediate 对比 process.nextTick</h4> <ul><li>setImmediate(fn)的回调任务会插入到宏队列 Check Queue 中</li> <li>process.nextTick(fn)的回调任务会插入到微队列 Next Tick Queue 中</li> <li>process.nextTick(fn)调用深度有限制，上限是 1000，而 setImmedaite 则没有</li></ul> <p><a href="https://juejin.cn/post/6844904077537574919" target="_blank" rel="noopener noreferrer">推荐一篇 Event Loop 测试题<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="http://www.ruanyifeng.com/blog/2013/10/event_loop.html" target="_blank" rel="noopener noreferrer">什么是 Event Loop？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://segmentfault.com/a/1190000016278115ECUST2020MBA%E5%85%A8%E6%97%A5%E5%88%B6%E4%B8%AD%E6%96%872%E7%8F%ADY41200009" target="_blank" rel="noopener noreferrer">参考文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/" target="_blank" rel="noopener noreferrer">nodejs 事件循环<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="_3-3-异步编程方法-发布-订阅"><a href="#_3-3-异步编程方法-发布-订阅" class="header-anchor">#</a> 3.3 异步编程方法-发布/订阅</h2> <h3 id="_3-3-1-理解发布-订阅"><a href="#_3-3-1-理解发布-订阅" class="header-anchor">#</a> 3.3.1 理解发布/订阅</h3> <h4 id="异步编程的几种方式"><a href="#异步编程的几种方式" class="header-anchor">#</a> 🍅 异步编程的几种方式</h4> <p><img src="/assets/img/asyncpro.36cea6ce.png" alt=""></p> <h4 id="回调的形式实现请求"><a href="#回调的形式实现请求" class="header-anchor">#</a> 🍅 回调的形式实现请求</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 实现省略</span>
<span class="token punctuation">}</span>
<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">'./test1.json'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">'./test2.json'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">'./test3.json'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="发布订阅的形式"><a href="#发布订阅的形式" class="header-anchor">#</a> 🍅 发布订阅的形式</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 发布订阅应用</span>
<span class="token keyword">function</span> <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 实现省略</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> pbb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PubSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">'./test1.json'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pbb<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'test1Success'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
pbb<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'test1Success'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">'./test2.json'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pbb<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'test2Success'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
pbb<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'test2Success'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">'./test3.json'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pbb<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'test3Success'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
pbb<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'test2Success'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ol><li>我们通过 <code>pbb.publish</code>这个方法发布<code>test1Success</code>这个事件</li> <li>然后去订阅这个事件</li></ol> <h4 id="发布和订阅图例"><a href="#发布和订阅图例" class="header-anchor">#</a> 🍅 发布和订阅图例</h4> <p><img src="/assets/img/publisher.bf1c86c0.png" alt=""></p> <h3 id="_3-3-2-实现事件发布-订阅"><a href="#_3-3-2-实现事件发布-订阅" class="header-anchor">#</a> 3.3.2 实现事件发布/订阅</h3> <h4 id="发布和订阅类的实现"><a href="#发布和订阅类的实现" class="header-anchor">#</a> 🍅 发布和订阅类的实现</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">PubSub</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 发出一个事件</span>
  <span class="token function">publish</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 订阅一个事件</span>
  <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 取消一个事件</span>
  <span class="token function">unSubcribe</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
        <span class="token parameter">cb</span> <span class="token operator">=&gt;</span> cb <span class="token operator">!==</span> callback
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="发布和订阅的优缺点"><a href="#发布和订阅的优缺点" class="header-anchor">#</a> 🍅 发布和订阅的优缺点</h4> <p>优点</p> <ul><li>松耦合</li> <li>灵活（多次去订阅一个事件）
缺点</li> <li>无法确保消息被触发或者触发几次</li></ul> <p><font color="red"><strong>发布订阅是 promise 之前的一个主流的解决请求高耦合的方案</strong></font></p> <h3 id="_3-3-3-node-js-的发布-订阅"><a href="#_3-3-3-node-js-的发布-订阅" class="header-anchor">#</a> 3.3.3 node.js 的发布/订阅</h3> <p>参考资料：/examples/jsadvanced/3.3/nodePubSub.js</p> <h2 id="_3-4-深入理解-promise"><a href="#_3-4-深入理解-promise" class="header-anchor">#</a> 3.4 深入理解 promise</h2> <p>因为 es6 的 promise 是按照 A+规范来写的，如果我们想要理解 promise 源码，需要先看 A+规范</p> <h3 id="_3-4-1-promise-a-规范"><a href="#_3-4-1-promise-a-规范" class="header-anchor">#</a> 3.4.1 promise A+规范</h3> <h4 id="术语"><a href="#术语" class="header-anchor">#</a> 🍅 术语</h4> <ul><li>promise 一个有 then 方法的对象或函数，其行为符合本规范</li> <li>thenable 一个定义了 then 方法的对象或函数</li> <li>value（值） 任何 javaScript 的合法值（包括 undefined,thenable 或 promise）</li> <li>exception（异常） throw 语句抛出的值</li> <li>reason（拒绝原因） 表示 promise 被拒绝原因的值</li></ul> <h4 id="promise-的状态"><a href="#promise-的状态" class="header-anchor">#</a> 🍅 promise 的状态</h4> <p><img src="/assets/img/promisestatus.31b616dd.png" alt=""></p> <p>pending：等待,可以转换成 fulfilled 或 rejected 状态</p> <p>fulfilled：完成，拥有一个不可变的终值</p> <p>rejected：拒绝，拥有一个不可变的据因</p> <p>一个 promise 的状态被改变了，就不能在改变了</p> <h4 id="promise-的-then-方法"><a href="#promise-的-then-方法" class="header-anchor">#</a> 🍅 promise 的 then 方法</h4> <p>一个 promise 必须提供一个 then 方法以访问最终值 value 和 reason</p> <p>promise 的 then 方法接受两个参数</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>then 方法的参数
<ul><li>两个函数参数，都是可选参数</li> <li>onFulfilled 在 promise 完成后被调用，onRejected 在 promise 被拒绝执行后调用；onFulfilled 和 onRejected 如果不是函数，其必须被忽略</li></ul></li> <li>then 方法的调用：可以调用多次</li> <li>then 方法的返回值：promise</li></ul> <p><font color="red"><strong>1. onFulfilled 和 onRejected 都是可选参数</strong></font>（参数可选）</p> <ul><li>onFulfilled 不是一个函数，则被忽略</li> <li>onRejected 不是一个函数，则被忽略</li></ul> <p><font color="red"><strong>2. 如果 onFulfilled 是一个函数</strong></font>（onFulfilled 特性）</p> <ul><li>它必须在 promise fulfilled 后调用，且 promise 的 value 为其第一个参数</li> <li>它不能在 promise fulfilled 前调用</li> <li>其调用次数不可超过一次</li></ul> <p><font color="red"><strong>3. 如果 onRejected 是一个函数</strong></font>（onRejected 特性）</p> <ul><li>它必须在 promise rejected 后调用，且 promise 的 reason 为其第一个参数</li> <li>它不能在 promise rejected 前调用</li> <li>其调用次数不可超过一次</li></ul> <p><font color="red"><strong>4. onFulfilled 和 onRejected 只有在执行环境堆栈仅包含平台代码时才可被调用</strong></font>（调用时机）</p> <p><font color="red"><strong>5. onFulfilled 和 onRejected 必须被作为函数调用（即没有 this 值）</strong></font>（调用要求）</p> <p><font color="red"><strong>6. then 方法可以被同一个 promise 调用多次</strong></font>（多次调用）</p> <ul><li>当 promise 成功执行时，所有 onFulfilled 需按照其注册顺序依次回调</li> <li>当 promise 被拒绝执行时，所有的 onRejected 需按照其注册顺序依次回调</li></ul> <p><font color="red"><strong>7. then 方法必须返回一个 promise 对象</strong></font>（返回）</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>promise2 <span class="token operator">=</span> promise1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>then 方法必须返回一个 promise，它实现了链式调用，它的返回值必须有 then 方法，所以它返回的是一个 promise；
既然 then 方法返回一个 promise，那么这个返回的 promise 的值是怎么确定的呢？假如我们返回的 promsie 是 promise2
那规范中分了 3 种情况；我们根据这 3 种情况来确定 promsie2 的值和状态是什么？</p> <p>返回的 primise2 的值和状态是怎样确定的？A+规范分了 3 种情况</p> <ol><li>onFulfilled 不是函数，promise1 的状态是 fulfilled</li></ol> <p>state：fulfilled
value：同 promise1</p> <ol start="2"><li>onRejected 不是函数，promise1 的状态是 rejected</li></ol> <p>state：rejected
reason：同 promise1</p> <ol start="3"><li>onFullfilled 或者 onRejected，return x（onFullfilled 或者 onRejected 有一个返回值，这个返回值是 x，这个时候规范定义了一个解析过程）</li></ol> <h4 id="promise-解析过程"><a href="#promise-解析过程" class="header-anchor">#</a> 🍅 promise 解析过程</h4> <ul><li>抽象模型 resolve(promise,x)</li> <li>如果 promise 和 x 指向相同的值
如果他们指向相同的值，就形成了循环引用；所以就 return resolve(promise,new TypeError('cant be the same'))</li> <li>如果 x 是一个 promsie,状态有 3 种</li> <li>如果 x 是一个对象或一个函数</li> <li>如果 x 不是对象也不是函数</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果promise和x指向相同的值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'cant be the same'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//如果x是一个promsie</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fulfill</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> v<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果x是一个对象或一个函数</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isFuction</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> then
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      then <span class="token operator">=</span> x<span class="token punctuation">.</span>then
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>then<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> isCalled <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          x<span class="token punctuation">,</span>
          <span class="token keyword">function</span> <span class="token function">reslovePromise</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isCalled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            isCalled <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token keyword">function</span> <span class="token function">rejectPromise</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isCalled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            isCalled <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCalled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fulfill</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果x不是对象也不是函数</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fulfill</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h4 id="案例"><a href="#案例" class="header-anchor">#</a> 🍅 案例</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
<span class="token comment">// 或</span>
<span class="token keyword">const</span> promise1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> promise2 <span class="token operator">=</span> promise1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> promise3 <span class="token operator">=</span> promise2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> promise4 <span class="token operator">=</span> promise3<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>

<span class="token comment">// 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Promise1 是 resolved 状态，它的 value 是 1，then 方法不函数的参数会忽略掉；promise2 的状态也是 resolved 状态；Value 也是 1；
第三步的参数还是会忽略掉，promise3 的状态也是 resolved 状态；Value 也是 1；第四步 console.log 是个函数，所以会打印出 1.</p> <h3 id="_3-4-2-es6-promise-api"><a href="#_3-4-2-es6-promise-api" class="header-anchor">#</a> 3.4.2 ES6 Promise API</h3> <h4 id="promise-构造函数"><a href="#promise-构造函数" class="header-anchor">#</a> 🍅 Promise 构造函数</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">// resolve(value)</span>
   <span class="token comment">// reject(reson)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>

 <span class="token comment">// 函数作为参数</span>
 resolve函数将promise的状态从pending变成resolved（fulfilled）
 reject函数将promise状态从pending变成rejected
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="promise-的静态方法"><a href="#promise-的静态方法" class="header-anchor">#</a> 🍅 Promise 的静态方法</h4> <table><thead><tr><th style="text-align:center;">方法</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">Promise.resolve(param)</td> <td style="text-align:center;">等同于 new Promise(function (resolve.,reject){resolve(param)})</td></tr> <tr><td style="text-align:center;">Promise.reject(reason)</td> <td style="text-align:center;">等同于 new Promise(function (resolve.,reject){reject(reason)})</td></tr> <tr><td style="text-align:center;">Promise.all([p1,...,pn])</td> <td style="text-align:center;">输入一组 promise 返回一个新的 promise，全部 promise 都是 fulfilled 结果才是 fulfilled 状态；如果有一个失败，结果 promise 就是失败</td></tr> <tr><td style="text-align:center;">Promise.allSettled([p1,...,pn])</td> <td style="text-align:center;">输入一组 promise 返回一个新的 promise，所有的 promise 状态改变后，结果 promise 变成 fulfilled</td></tr> <tr><td style="text-align:center;">Promise.race([p1,...,pn])</td> <td style="text-align:center;">输入一组 promise 返回一个新的 promise，结果 promise 的状态跟随第一个变化的 promsie 状态，最先返回 promise 是成功的，结果 promise 就是成功，否则就是失败</td></tr></tbody></table> <h4 id="promise-的实例方法"><a href="#promise-的实例方法" class="header-anchor">#</a> 🍅 Promise 的实例方法</h4> <table><thead><tr><th style="text-align:center;">方法</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">promise.then（onFulfilled，onRejected）</td> <td style="text-align:center;">promise 状态改变之后的回调，返回新的 promise 对想</td></tr> <tr><td style="text-align:center;">Promise.catch(reason)</td> <td style="text-align:center;">同 promise.then(null,onRejected),promise 状态为 rejected 回调</td></tr> <tr><td style="text-align:center;">Promise.finally(function（reason）{ })</td> <td style="text-align:center;">不管 promise 的状态如何都会执行</td></tr></tbody></table> <p>then 和 catch 都会返回一个新的 promise，链式调用的时候 catch 会冒泡到最后一层</p> <h3 id="_3-4-3-promise-实践"><a href="#_3-4-3-promise-实践" class="header-anchor">#</a> 3.4.3 promise 实践</h3> <p>3 秒后亮一次红灯,再过 2 秒亮一次绿灯,在过 1 秒亮一次黄灯,用 promise 实现多次交替亮灯的效果</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">light</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> second</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> second <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token number">3</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'green'</span><span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'yellew'</span><span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token keyword">function</span> <span class="token function">orderLights</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">light</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>color<span class="token punctuation">,</span> item<span class="token punctuation">.</span>time<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">orderLights</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">orderLights</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="_3-5-generator-函数及其异步的应用"><a href="#_3-5-generator-函数及其异步的应用" class="header-anchor">#</a> 3.5 Generator 函数及其异步的应用</h2> <h3 id="_3-5-1-generator-函数"><a href="#_3-5-1-generator-函数" class="header-anchor">#</a> 3.5.1 Generator 函数</h3> <p>Generator 函数可以直接生成迭代器，也是 es6 异步编程的解决方案</p> <ul><li>es6 异步编程解决方案</li> <li>声明：通过 function *声明</li> <li>返回值：符合可迭代协议和迭代器协议的生成器对象</li> <li>在执行时能暂停，又能从暂停出继续执行</li></ul> <p>生成器对象原型上有 3 个方法：1.next(param); 2.return(param) 3.throw(param)</p> <h4 id="先看-2-个概念-迭代器-vs-生成器"><a href="#先看-2-个概念-迭代器-vs-生成器" class="header-anchor">#</a> 🍅 先看 2 个概念：迭代器 vs 生成器</h4> <ul><li>迭代器
<ul><li>有 next 方法，执行返回结果对象
结果对象包含：1.value 2.done</li></ul></li></ul> <p>用 es5 自己写一个迭代器，让大家看的更清楚</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> done <span class="token operator">=</span> i <span class="token operator">&gt;=</span> item<span class="token punctuation">.</span>length
      <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token operator">!</span>done <span class="token operator">?</span> item<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">undefined</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        done<span class="token operator">:</span> done<span class="token punctuation">,</span>
        value<span class="token operator">:</span> value
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { done: false, value: 1 }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { done: false, value: 2 }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { done: false, value: 3 }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { done: true, value: undefined }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="迭代协议"><a href="#迭代协议" class="header-anchor">#</a> 🍅 迭代协议</h4> <ol><li>可迭代协议</li></ol> <ul><li>[Symblo.iterator]属性</li> <li>内置可迭代对象
<ul><li>String Array Map Set 等</li></ul></li></ul> <ol start="2"><li>迭代器协议</li></ol> <ul><li>next 方法
<ul><li>done</li> <li>value</li></ul></li></ul> <h4 id="yield-关键字"><a href="#yield-关键字" class="header-anchor">#</a> 🍅 yield 关键字</h4> <ul><li>只能出现在 Generator 函数</li> <li>用来暂停和恢复生成器函数</li> <li>next 执行
<ul><li>遇 yield 暂停，将紧跟 yield 表达式的值作为返回的对象的 value</li> <li>没有 yield，一直执行到 return，将 return 的值作为返回的对象的 value</li> <li>没有 return，将 undefined 作为返回的对象的 value</li></ul></li> <li>next 参数
<ul><li>next 方法可以作为一个参数，该参数会被当作一个 yield 表达式的返回值</li></ul></li></ul> <p>案例 1</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> first <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span>
  <span class="token keyword">let</span> second <span class="token operator">=</span> <span class="token keyword">yield</span> first <span class="token operator">+</span> <span class="token number">2</span>
  <span class="token keyword">yield</span> second <span class="token operator">+</span> <span class="token number">3</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// {value:1,done:false}</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// {value:6,done:false}</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// {value:8,done:false}</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// {value:undefined,done:true}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>运行流程：</p> <ol><li><p>第一次 next 遇到 yield 会把 yield 后面跟的表达式的值作为返回对象的 value，这个表达式是 1，所以 value 是 1</p></li> <li><p>第二个 next 执行的时候，上一次 next 执行的时候 yield 1 返回了，但是 first 的值还未赋值；因为我们执行
yield 的时候就停了，停了之后到第二个 next 执行的时候会才会从 first 这个值开始执行，next 传入了参数 4 会把
第一次执行的 yield 值改变，所以这个时候 fisrt 是 4，那么 first+2 是 6，这时候还没执行完 done 是 false，value 是 6</p></li> <li><p>第三次执行 next，传入了 5，那么 second 是 5，所以 value 是 8</p></li> <li><p>第四次执行 next，前一次执行完 next 后，看着代码已经执行完了，然而相当于后面还有 return undefined</p></li></ol> <h4 id="yield-生成器函数-可迭代对象"><a href="#yield-生成器函数-可迭代对象" class="header-anchor">#</a> 🍅 yield* 生成器函数/可迭代对象</h4> <ul><li>委托其他可迭代对象</li> <li>作用：复用生成器</li></ul> <p>案例 2</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">generator1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span>
  <span class="token keyword">yield</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gennerator2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">100</span>
  <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">generator1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token number">200</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> g2<span class="token operator">=</span><span class="token function">generator2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
g2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>value<span class="token operator">:</span><span class="token number">100</span><span class="token punctuation">,</span>done<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span>
g2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>value<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>done<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span>
g2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>value<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>done<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span>
g2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>value<span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">,</span>done<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span>
g2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>value<span class="token operator">:</span><span class="token keyword">undefined</span><span class="token punctuation">,</span>done<span class="token operator">:</span>ture<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="return-param"><a href="#return-param" class="header-anchor">#</a> 🍅 return(param)</h4> <ul><li>给定 param 值终结遍历器，param 可缺省</li></ul> <p>案例 3</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">createIterator</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token number">1</span>
    <span class="token keyword">yield</span> <span class="token number">2</span>
    <span class="token keyword">yield</span> <span class="token number">3</span>
  <span class="token punctuation">}</span>
 <span class="token keyword">let</span> iterator<span class="token operator">=</span>createIterator（）
 iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">{</span>value<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>done<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span>
 iterator<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">{</span>value<span class="token operator">:</span><span class="token keyword">undefined</span><span class="token punctuation">,</span>done<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span>
 iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">{</span>value<span class="token operator">:</span><span class="token keyword">undefined</span><span class="token punctuation">,</span>done<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="thorow-param"><a href="#thorow-param" class="header-anchor">#</a> 🍅 thorow(param)</h4> <ul><li>让生成器对象内部抛出错误
案例 4</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> first <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span>
  <span class="token keyword">let</span> second
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    second <span class="token operator">=</span> <span class="token keyword">yield</span> first <span class="token operator">+</span> <span class="token number">2</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    second <span class="token operator">=</span> <span class="token number">6</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">yield</span> seond <span class="token operator">+</span> <span class="token number">3</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// {value:1,done:false}</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// {value:12,done:false}</span>
iterator<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// {value:9,done:false}  遇到yield才会暂停</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//{value:undefined,done:true}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="协程"><a href="#协程" class="header-anchor">#</a> 🍅 协程</h4> <ul><li>一个线程存在多个协层，但同时只能执行一个</li> <li>Genrator 函数的协层在 ES6 的实现</li> <li>Yield 挂器 x 协程（交给其他协程），next 唤醒 x 协程</li></ul> <h4 id="generator-函数的应用"><a href="#generator-函数的应用" class="header-anchor">#</a> 🍅 Generator 函数的应用</h4> <p>回调函数的写法</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">readFilesByCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'/Users/kitty/testgenerator/1.json'</span><span class="token punctuation">,</span>
    <span class="token string">'/Users/kitty/testgenerator/2.json'</span><span class="token punctuation">,</span>
    <span class="token string">'/Users/kitty/testgenerator/3.json'</span>
  <span class="token punctuation">]</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 调用</span>
<span class="token function">readFilesByCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>generator 函数的写法</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">readFilesByGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'/Users/kitty/testgenerator/1.json'</span><span class="token punctuation">,</span>
    <span class="token string">'/Users/kitty/testgenerator/2.json'</span><span class="token punctuation">,</span>
    <span class="token string">'/Users/kitty/testgenerator/3.json'</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">let</span> fileStr <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      f<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">yield</span> <span class="token function">readFile</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">readFile</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">readFile</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 调用</span>
<span class="token keyword">const</span> f <span class="token operator">=</span> <span class="token function">readFilesByGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

f<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>缺点：需要在 readFile 函数内部调用生成器 f，不是很优雅，thunk 能把这个耦合能解开来，不用在函数内部调用函数外部的变量</p> <h3 id="_3-5-2-thunk-函数"><a href="#_3-5-2-thunk-函数" class="header-anchor">#</a> 3.5.2 Thunk 函数</h3> <ul><li>求职策略 传值调用，传名调用 sum（x+1，x+2）
<ul><li>传值调用就是在计算 sum 之前先计算 x+1 和 x+2 的值，这 2 个值有了才传入 sum 函数里面计算</li> <li>传名调用是等函数内部用到 x+1 和 x+2 的时候在计算</li></ul></li> <li>thunk 函数是传名调用的实现方式之一</li> <li>可以实现自动执行 Generator 函数</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">Thunk</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> readFileThunk <span class="token operator">=</span> <span class="token function">Thunk</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> gen <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span>
    result<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">g</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> s1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">readFileThunk</span><span class="token punctuation">(</span><span class="token string">'/Users/kitty/testgenerator/1.json'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> s2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">readFileThunk</span><span class="token punctuation">(</span><span class="token string">'/Users/kitty/testgenerator/2.json'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> s3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">readFileThunk</span><span class="token punctuation">(</span><span class="token string">'/Users/kitty/testgenerator/3.json'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s3<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="_3-6-深入理解-async-await"><a href="#_3-6-深入理解-async-await" class="header-anchor">#</a> 3.6 深入理解 async/await</h2> <h3 id="_3-6-1-async-函数"><a href="#_3-6-1-async-函数" class="header-anchor">#</a> 3.6.1 async 函数</h3> <h4 id="async"><a href="#async" class="header-anchor">#</a> 🍅 async</h4> <ul><li>一个语法糖 是异步操作更简单</li> <li>返回值 返回值是一个 promise 对象
<ul><li>return 的值是 promise resolved 时候的 value</li> <li>Throw 的值是 Promise rejected 时候的 reason</li></ul></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment">// 打印出一个promise，状态是resolved，value是1</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">//1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment">// 打印出一个promise，状态是rejected，value是error</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">//打印出的promise的reason 是error</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看出 async 函数的返回值是一个 promise</p> <h4 id="await"><a href="#await" class="header-anchor">#</a> 🍅 await</h4> <ul><li>只能出现在 async 函数内部或最外层</li> <li>等待一个 promise 对象的值</li> <li>await 的 promise 的状态为 rejected，后续执行中断</li></ul> <p>await 可以 await promise 和非 promsie，如果非 primse，例如：await 1 就返回 1</p> <p><img src="/assets/img/await.030322c2.png" alt=""></p> <p>await 为等待 promise 的状态是 resolved 的情况</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 start'</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// await为等待promise的状态，然后把值拿到</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promsie<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2 promise'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">/*
    打印结果
    async1 start
    async2 promise
    async1 end
  */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>await 为等待 promise 的状态是 rejected 的情况</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
  <span class="token comment">//后续代码不会执行</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token number">100</span>
<span class="token punctuation">}</span>

<span class="token comment">// 解决方案1</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 异常处理</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token number">100</span>
<span class="token punctuation">}</span>

<span class="token comment">// 解决方案2</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 异常处理</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token number">100</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="async-函数实现原理"><a href="#async-函数实现原理" class="header-anchor">#</a> 🍅 async 函数实现原理</h4> <p>实现原理：Generator+自动执行器</p> <p>async 函数是 Generator 和 Promise 的语法糖</p> <h3 id="_3-6-2-应用"><a href="#_3-6-2-应用" class="header-anchor">#</a> 3.6.2 应用</h3> <h4 id="用-async-函数方案读取文件"><a href="#用-async-函数方案读取文件" class="header-anchor">#</a> 🍅 用 async 函数方案读取文件</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">readFilesByAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'/Users/kitty/testgenerator/1.json'</span><span class="token punctuation">,</span>
    <span class="token string">'/Users/kitty/testgenerator/2.json'</span><span class="token punctuation">,</span>
    <span class="token string">'/Users/kitty/testgenerator/3.json'</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">const</span> <span class="token function-variable function">readFile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> str0 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str0<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> str1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> str2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="_3-7-手写-promise"><a href="#_3-7-手写-promise" class="header-anchor">#</a> 3.7 手写 Promise</h2> <h3 id="_3-7-1-先实现整体结构"><a href="#_3-7-1-先实现整体结构" class="header-anchor">#</a> 3.7.1 先实现整体结构</h3> <p>定义一个模块</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 我们用es5的自执行函数定义模块，如果用AMD规范的需要编译，用自执行函数方便我们一会调用测试</span>
<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">window</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  window<span class="token punctuation">.</span>Promise <span class="token operator">=</span> Promise
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>基本结构</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">window</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// executor执行器，就是我们new Promise((resolve,reject)=&gt;) 传过来的函数，它是同步执行的</span>
  <span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">/**
   * then方法指定了成功的和失败的回调函数,如果指定的不是函数，会忽略该值
   * 返回一个新的promise对象，该promsie的结果onResolved和onRejected决定，状态由上个Promise决定
   */</span>
  <span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onResolved<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">/**
   * 传入失败回调
   * 返回一个新的Promise,由于已经捕获错误了，会返回一个成功的Promise
   */</span>
  <span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">OnRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">/**
   * 返回一个指定结果成功的promise
   */</span>
  Promise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">/**
   * 返回一个指定reason失败的promise
   */</span>
  Promise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">/**
   * 返回一个新Promsie
   * 所有的promise成功才成功，有一个失败就失败
   */</span>
  Promise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">/**
   * 返回一个新Promsie
   * 传入的数组中第一个返回的Promise成功就成功，如果不成功就失败(第一个promise不是你传入的第一个，比如请求接口，最新拿到结果的是第一个)
   */</span>
  Promise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  window<span class="token punctuation">.</span>Promise <span class="token operator">=</span> Promise
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="_3-7-2-实现-promise-内部的-resolve-和-reject"><a href="#_3-7-2-实现-promise-内部的-resolve-和-reject" class="header-anchor">#</a> 3.7.2 实现 Promise 内部的 resolve 和 reject</h3> <p>当我们<code>new promise((resolve,reject)=&gt;{})</code>时会传入一个回调函数，我们这里叫 executor(执行器)，promise 拿到这个方法以后，
调用这个 executor 方法并传入 resolve 和 reject 方法，让用户控制 promise 是成功还是失败；调用 resolve 是成功，调用 reject 是失败。</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">window</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 常量定义3promise的三个状态</span>
  <span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span>
  <span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span>
  <span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span>
  <span class="token comment">// executor执行器，就是我们new Promise((resolve,reject)=&gt;) 传过来的函数，它是同步执行的</span>
  <span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存一下this，因为代码中调用resolve时，在全局下调用的，此时resolve里面this是window</span>
    <span class="token comment">// 关于this指向问题，就是谁调用就指向谁，当然也可以用箭头函数处理这个问题</span>
    <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span>
    self<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">//存传的值</span>
    self<span class="token punctuation">.</span>callbackQueues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 存回调队列</span>

    <span class="token comment">// 让promise成功的函数</span>
    <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span>
      self<span class="token punctuation">.</span>state <span class="token operator">=</span> value
      <span class="token comment">/*
      这里会让人感到疑惑？下面是干什么的？
      onResolved是then方法的第一个参数，onRejected是第二个参数
      其实promise用了发布订阅的设计模式，promise把then方法的OnResolved和OnRejected方法存到一个数组里
      不懂没关系，可以看下面的我分析的代码执行步骤
    */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>callbackQueues<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>callbackQueues<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span><span class="token function">onResolved</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 让promsie失败的函数</span>
    <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果不是pending状态，就没必要往下了，因为promise的状态一旦改变就无法在更改</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span>
      self<span class="token punctuation">.</span>state <span class="token operator">=</span> reason

      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>callbackQueues<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>callbackQueues<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span><span class="token function">onRejected</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 捕获executor函数里意外错误，如果错误改变状态</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * then方法指定了成功的和失败的回调函数
   * 返回一个新的promise对象
   */</span>
  <span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onResolved<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> seft <span class="token operator">=</span> <span class="token keyword">this</span>
    seft<span class="token punctuation">.</span>callbackQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      onResolved<span class="token punctuation">,</span>
      onRejected
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  window<span class="token punctuation">.</span>Promise <span class="token operator">=</span> Promise
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><h4 id="分析一下代码执行步骤"><a href="#分析一下代码执行步骤" class="header-anchor">#</a> 分析一下代码执行步骤</h4> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./Promise.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol><li><code>new Promise()</code> 会传入一个回调函数到构造函数 Promise 中，然后执行 Promise 里的代码。</li> <li>开始就是 <code>const self=this</code> 的执行，这些不是重点，重点是执行<code>executor(resolve,reject)</code>,并传入 resolve 和 reject 函数。</li> <li>开始执行<code>executor</code>函数，函数里执行了<code>setTimeout</code>，我们知道<code>setTimeout</code>是异步执行的，接下来会执行<code>then</code>方法。</li> <li>执行 then 方法并传入了<code>onResolved</code>函数，then 方法里把传入的<code>onResolved</code>push 到了<code>callbackQueues</code>数组里。</li> <li>同步的代码执行完了，开始执行异步任务了，显然是指行 setTimeout 里 resovle 方法。</li> <li>在 resolve 方法里开始判断不是<code>pending</code>状态就退出，然后就把状态改成<code>fulfilled</code>,把传过来的值存到<code>state</code>里；然后执行<code>callbackQueues</code>
里的函数，callbackQueues 里存的 then 方法传回调函数，调用里面的回调把<code>state</code>值传进去。</li></ol> <p>上面代码只是简单的实现了<code>then</code>方法，接下来我们具体实现</p> <h3 id="_3-7-3-实现-promise-原型上的-then-方法"><a href="#_3-7-3-实现-promise-原型上的-then-方法" class="header-anchor">#</a> 3.7.3 实现 Promise 原型上的 then 方法</h3> <p><font color="red"><strong>看到这么多代码不要慌张，我会拆分详细讲解，then 方法是 Promise 的重点，其他方法都跟 then 方法有关系</strong></font></p> <p>我们要先明确 then 方法实现了什么？</p> <ol><li>返回一个新的 Promsie</li> <li>新的 promise 的值由上一个 Promsie 的 onResolved 和 onRejected 的结果决定</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onResolved<span class="token punctuation">,</span>onRejected</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> self<span class="token operator">=</span> <span class="token keyword">this</span>
   <span class="token comment">/*
    我们为什么把判断写到promise里面？

    因为我们需要根据上一个Promsie的状态去改变当前这个返回的promise的状态
    上一个promsie的状态可以根据seft.status拿到，我们要改变返回的这个promise的状态，
    就是调用resolve或reject，我们只有写在promise里面才到调用这两个函数
   */</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     <span class="token comment">// 我们调用then方法的时候 ，promise可能是以下三种状</span>

     <span class="token comment">// 如果是pending状态，那么说明Promsie内部的resolve还没执行，因为如果执行了，resolve函数会改变状态的</span>
     <span class="token comment">// 由于resolve函数还未执行，我们也拿不到传过来的值，先把回调函数放到callbackQueues数组中</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>seft<span class="token punctuation">.</span>status<span class="token operator">===</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         seft<span class="token punctuation">.</span>callbackQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
               onResolved<span class="token punctuation">,</span>
               onRejected
         <span class="token punctuation">}</span><span class="token punctuation">)</span>

     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>seft<span class="token punctuation">.</span>status<span class="token operator">===</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token comment">// 用self.state 拿到当前promsie state的值，把值传递给使用者传入的第一个回调函数</span>
       <span class="token function">onResolved</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">)</span>

     <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用self.state 拿到当前promsie state的值，把值传递给使用者传入的第二个回调函数</span>
        <span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

 <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>上面我们实现了，返回一个 promsie，并调用了传递过来的 onResolved 和 onRejected 函数，接下来我们改变这个返回 promise 的状态</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onResolved<span class="token punctuation">,</span>onRejected</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> self<span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>seft<span class="token punctuation">.</span>status<span class="token operator">===</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          seft<span class="token punctuation">.</span>callbackQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                onResolved<span class="token punctuation">,</span>
                onRejected
          <span class="token punctuation">}</span><span class="token punctuation">)</span>

     <span class="token comment">// 当前Promise fulfilled状态时</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>seft<span class="token punctuation">.</span>status<span class="token operator">===</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/*
          const p = new Promise((resolve,reject)=&gt;{resolve(1)})
          p.then((res)=&gt;{
            return 2
             or
            return new Promise((resolve,reject)=&gt;{resolve(2)})
          })
        */</span>
        <span class="token comment">// 我们调用onResolved拿到函数的返回值，这个返回值，也有可能是一个promise</span>
        <span class="token keyword">const</span> result<span class="token operator">=</span> <span class="token function">onResolved</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result instance Promise<span class="token punctuation">)</span><span class="token punctuation">{</span>
          result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">// 调用then方法拿到值</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 改变返回的这个promise状态为fulfilled，并传入了值</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// 改变返回的这个promise状态为fulfilled，并传入了值</span>
        <span class="token punctuation">}</span>

      <span class="token comment">// 当前Promise 为rejected状态时，下面的实现方法跟上面基本一样</span>
      <span class="token comment">// 为什么我们下面也调用resolve，因为onRejected这个函数中已经捕获了错误</span>
      <span class="token comment">// 一旦有onRejected函数捕获了错误，错误就不再往下传递，让下一个promise成功！</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> result<span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result instance Promise<span class="token punctuation">)</span><span class="token punctuation">{</span>
          result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">// 调用then方法拿到值</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 改变返回的这个promise状态为fulfilled，并传入了值</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// 改变返回的这个promise状态为fulfilled，并传入了值</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>把相同的代码封装成一个函数 handle,我们知道 promsie 的 then 的回调函数是异步的，所以 setTimeout 模拟 then 方法的异步问题</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onResolved<span class="token punctuation">,</span>onRejected</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">const</span> self<span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token comment">// 把相同的代码封装起来,并用try catch捕获错误</span>
      <span class="token comment">/*
        像这种情况，使用者如果抛出错误，直接让下个promise也就是当前返回的promise状态为失败
       then(res=&gt;{
         throw '我抛出错误'
       })
      */</span>
    <span class="token keyword">function</span> <span class="token function">handle</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
           <span class="token keyword">const</span> result<span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>result instance Promise<span class="token punctuation">)</span><span class="token punctuation">{</span>
              result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
     <span class="token comment">// 当前Promise pending状态时</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>seft<span class="token punctuation">.</span>status<span class="token operator">===</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          seft<span class="token punctuation">.</span>callbackQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                onResolved<span class="token punctuation">,</span>
                onRejected
          <span class="token punctuation">}</span><span class="token punctuation">)</span>

     <span class="token comment">// 当前Promise fulfilled状态时</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>seft<span class="token punctuation">.</span>status<span class="token operator">===</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token function">handle</span><span class="token punctuation">(</span>onResolved<span class="token punctuation">)</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 当前Promise 为rejected状态时</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
           <span class="token function">handle</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>then 方法已经实现的差不多了，但是 promise 为 pending 状态时，我们没有去改变返回那个 promise 的状态，改变状态需要调用 resolve 或 reject
然而我们并没有调用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onResolved<span class="token punctuation">,</span>onRejected</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 如果传入的不是函数，就用默认函数，并把上一个promse的值往下传递</span>
  <span class="token keyword">const</span> onResolved<span class="token operator">=</span><span class="token keyword">typeof</span> onResolved <span class="token operator">===</span><span class="token string">'fucntion'</span> <span class="token operator">?</span> <span class="token function-variable function">onResolved</span> <span class="token operator">:</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>value
  <span class="token comment">// 如果传入的不是函数，就给默认函数，并抛出错误，让返回的这个promsie为失败状态</span>
  <span class="token keyword">const</span> onResolved<span class="token operator">=</span><span class="token keyword">typeof</span> onRejected <span class="token operator">===</span><span class="token string">'fucntion'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token keyword">throw</span> reason<span class="token punctuation">}</span>

    <span class="token keyword">const</span> self<span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>

    <span class="token keyword">function</span> <span class="token function">handle</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/*省略*/</span>
      <span class="token punctuation">}</span>
     <span class="token comment">// 当前Promise pending状态时</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>seft<span class="token punctuation">.</span>status<span class="token operator">===</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          seft<span class="token punctuation">.</span>callbackQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token function">onResolved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                  <span class="token function">handle</span><span class="token punctuation">(</span>onResolved<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                 <span class="token function">handle</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>seft<span class="token punctuation">.</span>status<span class="token operator">===</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 当前Promise fulfilled状态时</span>
        <span class="token comment">/*省略*/</span>

      <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// 当前Promise 为rejected状态时</span>
         <span class="token comment">/*省略*/</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>then 完整代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * then方法指定了成功的和失败的回调函数
 * 返回一个新的promise对象，它实现了链式调用
 * 返回的promise的结果由onResolved和onRejected决定
 */</span>
<span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onResolved<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  onResolved <span class="token operator">=</span> <span class="token keyword">typeof</span> onResolved <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onResolved</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value
  onRejected <span class="token operator">=</span>
    <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span>
      <span class="token operator">?</span> <span class="token function-variable function">onRejected</span>
      <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> reason
        <span class="token punctuation">}</span>
  <span class="token keyword">const</span> seft <span class="token operator">=</span> <span class="token keyword">this</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>seft<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
            <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 当是Promise状态为pending时候，将onResolved和onRejeactd存到数组中callbackQueues</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seft<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      seft<span class="token punctuation">.</span>callbackQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function">onResolved</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handle</span><span class="token punctuation">(</span>onResolved<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handle</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seft<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">handle</span><span class="token punctuation">(</span>onResolved<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">handle</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h3 id="_3-7-4-实现-promsie-原型的-catch-方法"><a href="#_3-7-4-实现-promsie-原型的-catch-方法" class="header-anchor">#</a> 3.7.4 实现 promsie 原型的 catch 方法</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 传入失败回调
 * 返回一个新的Promise
 */</span>
<span class="token comment">// 第一个参数不传，then里面会有默认参数，传入OnRejected回调函数</span>
<span class="token comment">// then 方法里会调用OnRejected并传入拒绝的理由</span>
<span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">OnRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> OnRejected<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_3-7-5-promise-resolve"><a href="#_3-7-5-promise-resolve" class="header-anchor">#</a> 3.7.5 Promise.resolve</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * Promise函数对象的resove方法
 * 返回一个指定结果成功的promise
 */</span>
<span class="token comment">// 这个简单 让返回的promise成功就行</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_3-7-6-promise-reject"><a href="#_3-7-6-promise-reject" class="header-anchor">#</a> 3.7.6 Promise.reject</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 *  Promise函数对象的reject方法
 * 返回一个指定reason失败的promise
 */</span>
<span class="token comment">// 这个简单 让返回的promise失败就行</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resove<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_3-7-7-promise-all"><a href="#_3-7-7-promise-all" class="header-anchor">#</a> 3.7.7 Promise.all</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 所有成功才成功，有一个失败就失败
 * 返回一个的Promise，这个promise的结果由传过来的数组决定，一个失败就是失败
 */</span>
<span class="token comment">// 这个也不难，循环传入的数组，把成功的promise的返回的值放到results中</span>
<span class="token comment">// 只有当results和promises长度相同时，说明全部成功，这时候返回一个成功的数组，有一个失败就失败</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        results<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_3-7-8-promise-race"><a href="#_3-7-8-promise-race" class="header-anchor">#</a> 3.7.8 Promise.race</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 第一个成功就成功，如果不成功就失败(就是最先拿到谁的值，就成功)
 * 返回一个Promsie
 */</span>
<span class="token comment">//  这个简单，只要发现一个promsie成功了，就让返回的promsie成功</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    promises<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_3-7-9-总结"><a href="#_3-7-9-总结" class="header-anchor">#</a> 3.7.9 总结</h3> <p>我们要实现 promsie 应该先看 A+规范，上一章有中文的翻版，当然也可以去网上看英文版，那我总结一下重点：</p> <ol><li><p>promise 用了发布订阅的设计模式。</p></li> <li><p>重点在 then 方法，它实现了返回一个新的 promise，这个 promsie 的状态由上一个 promsie 的状态所决定。</p></li> <li><p>调用 resolve 和 reject 去改变 promise 的状态</p></li></ol> <p><a href="https://github.com/hejialianghe/Senior-FrontEnd/tree/master/examples/jsadvanced/promise" target="_blank" rel="noopener noreferrer">完整代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="_3-8-web-workers-的多线程机制"><a href="#_3-8-web-workers-的多线程机制" class="header-anchor">#</a> 3.8 Web Workers 的多线程机制</h2> <h3 id="_3-8-1-web-workers-介绍"><a href="#_3-8-1-web-workers-介绍" class="header-anchor">#</a> 3.8.1 Web Workers 介绍</h3> <ul><li>web Workers
<ul><li>一个 Web API-&gt; 浏览器能力 -&gt; 提供一个 js 可以运行的环境</li> <li>Web 应用程序可以在独立于主线层的后台线程中，运行一个脚本操作</li> <li>关键点：性能考虑</li></ul></li></ul> <p>web Workers 主要处理一些耗时的任务，比如一家公司老板忙不来，肯定会招一些人，这些会承担一些公司的脏活累活，占用时间比较多的活，老板只做一些核心的事情。所以 web worker 是来分担主线程的负担的，所以 web worker 的意义在于一些耗时的任务从主线层剥离出来，让 worker 做这些耗时的处理；
那么主线程专注于页面的渲染和交互，那么我们访问的页面的性能会更好。</p> <h4 id="worker-的主要方法"><a href="#worker-的主要方法" class="header-anchor">#</a> worker 的主要方法</h4> <ul><li>onerror、onmessage、onmessageerror、postMessage、importScripts、close</li></ul> <h4 id="worker-线程和主线程的通信"><a href="#worker-线程和主线程的通信" class="header-anchor">#</a> 🍅 worker 线程和主线程的通信</h4> <img width="500px" src="/assets/img/worker-info.f5fca68d.png"> <p>我们知道 worker 是一个线程，那么主线程指派任务给 worker 线程是怎样通信的呢？就设计到 2 个线程之间的通信。</p> <p>主线程有一个<code>postMessage</code>方法用来通知 worker 线程任务，worker 有一个<code>onMessage</code>的方法用来接收主线程的任务，接收到主线程的消息之后就去工作，工作完之后 worker 也有一个<code>postMessage</code>方法用来通知主线程干完了；主线程也有一个<code>onMessage</code>方法，能获取到 worker 的工作已经做完了，以及结果是什么。</p> <h3 id="_3-8-2-实战一个-web-worker-的案例"><a href="#_3-8-2-实战一个-web-worker-的案例" class="header-anchor">#</a> 3.8.2 实战一个 web worker 的案例</h3> <p>这个案例是我们把耗时的斐波那契数列放到 worker 里计算</p> <ol><li>index.html</li></ol> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./main.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="2"><li>main.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//  new Worker 之后，worker进行工作</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'worker.js'</span><span class="token punctuation">)</span>

worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'拿到worker通知的数据'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
  worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'message收到了'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>worker.js</li></ol> <p>worker 线程去计算斐波那契数列</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">||</span> n <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 告诉主线程</span>
<span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 收到主线程的消息</span>
<span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'好的，拿到了就好'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="当你点开-index-html-会出现报错"><a href="#当你点开-index-html-会出现报错" class="header-anchor">#</a> 当你点开 index.html 会出现报错</h4> <p><img src="/assets/img/worker-err.22ef6023.png" alt=""></p> <p>这个报错是什么原因呢？</p> <p>因为我们用 worker 是限制的，不是本地跑一个 html 就行，<code>new Worker(&quot;worker.js&quot;)</code>里的参数不能通过本地路径去取的，不支持 file 协议；需要起一个静态资源服务，我们可以用<code>browser-sync</code>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> -g browser-sync <span class="token comment"># 下载</span>

-browser-sync start --server <span class="token comment"># 启动，注意启动服务要在index.html这个文件夹</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>xw
启动完之后，访问http://localhost:3000/index.html</p> <p>源代码地址：Senior-FrontEnd/examples/jsadvanced/3.8/</p> <h3 id="_3-8-3-worker-的能力是受限制的"><a href="#_3-8-3-worker-的能力是受限制的" class="header-anchor">#</a> 3.8.3 worker 的能力是受限制的</h3> <h4 id="预习资料-2"><a href="#预习资料-2" class="header-anchor">#</a> 预习资料</h4> <table><thead><tr><th style="text-align:center;">预习资料名称</th> <th style="text-align:center;">链接</th> <th style="text-align:center;">备注</th></tr></thead> <tbody><tr><td style="text-align:center;">Blob 对象用法</td> <td style="text-align:center;"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">嵌入式 webworkers 会用到 Blob</td></tr> <tr><td style="text-align:center;">JavaScript 中的 Blob 对象</td> <td style="text-align:center;"><a href="https://juejin.im/entry/5937c98eac502e0068cf31ae" target="_blank" rel="noopener noreferrer">阅读地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:center;">掘金上比较基础的一篇文章</td></tr></tbody></table> <ul><li><p>与主线程脚本同源</p> <p>在主线程下运行的 worker 必须与主线程同源</p></li> <li><p>与主线程上下文不同</p> <ul><li>在 worker 下无法操作 dom，可以操作 Navigator、location 等，就是不会引起页面混乱的可以用。</li> <li>不能执行 alert 等</li></ul></li> <li><p>不能读取本地文件</p> <ul><li>所有加载的文件来源于网络，不来来源于 file 协议。</li></ul></li></ul> <p>可以在 worker.js 下打印 this 看一下它的全局对象</p> <h4 id="嵌入式-worker"><a href="#嵌入式-worker" class="header-anchor">#</a> 嵌入式 worker</h4> <p>我们刚刚了解到，<code>new Worker(woker路径)</code>里的路径不能去从本地读取的，但是我们现在很多都是模块的写法，很多都会用到<code>require.js</code>,那么有没有简单的方法在项目中使用 workers 呢？看下面案例。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- type=&quot;javascript/worker&quot; 写上这个类型，里面的脚本是不会执行的 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript/worker<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>worker<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">function</span> <span class="token function">fibonacci</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>n<span class="token operator">===</span><span class="token number">1</span> <span class="token operator">||</span> n <span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token comment">// 拿到worker里的代码字符串</span>
      <span class="token keyword">var</span> workerScript <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#worker'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent
      <span class="token comment">// Blob ：二进制大对象</span>
      <span class="token keyword">var</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>workerScript<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'text/javascript'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// blob:null/9d8594c9-1783-46f9-8001-c6112af6a15a 可以在浏览器中访问，可以看见worker里的代码</span>
      <span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span>
      worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'拿到worker通知的数据'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'message收到了'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h4 id="webworkify"><a href="#webworkify" class="header-anchor">#</a> webworkify</h4> <p>如果按照上面的写法，在 2 个 script 标签里面写，显得不是很优雅；于是前辈给我们封装了<code>webworkify</code>,它也是利用<code>blob</code>、<code>createObjectURL</code>。</p> <h3 id="_3-8-4-web-worker-的使用场景"><a href="#_3-8-4-web-worker-的使用场景" class="header-anchor">#</a> 3.8.4 Web Worker 的使用场景</h3> <ul><li>解决的痛点
<ul><li>js 执行复杂运算时阻塞了页面渲染</li></ul></li> <li>使用场景
<ul><li>复杂运算</li> <li>渲染优化（canvas 有个离线的 api 结合 worker）</li> <li>流媒体数据处理</li></ul></li></ul> <h4 id="哪些项目中用到了-web-worker"><a href="#哪些项目中用到了-web-worker" class="header-anchor">#</a> 哪些项目中用到了 Web worker？</h4> <ul><li>flv.js
用 h5 的标签去播放 flv 格式的视频，用于直播、录播，它去解码 http-flv 格式的视频，通过 Media SourceExtensions,解码的过程就是在 workers 里执行的。</li></ul> <p>了解 SharedWorker 和 ServiceWOrker（pwa 的基础，可以做页面的缓存优化）</p> <h2 id="_3-9-service-workers"><a href="#_3-9-service-workers" class="header-anchor">#</a> 3.9 Service Workers</h2> <h3 id="_3-9-1-初识-service-workers"><a href="#_3-9-1-初识-service-workers" class="header-anchor">#</a> 3.9.1 初识 Service Workers</h3> <p>Service Worker（以下简称 sw）是基于 WEB Worker 而来的。</p> <p>Service Workers 的本质充当 WEB 应用程序、浏览器与网络（可用时）之间的代理服务器，这个 API 旨在创建有效的离线体验，它会拦截网络请求并根据网络是否可用来采取适当的动作，更新来自服务器的资源，它还提供入口推送通知和访问后台同步 API。</p> <h4 id="service-worker-的特点"><a href="#service-worker-的特点" class="header-anchor">#</a> 🍅 service worker 的特点 <span class="badge tip" style="vertical-align:top;" data-v-76652c5d>重要</span></h4> <ul><li>网站必须使用 HTTPS，除了本地开发环境（localhost）</li> <li>运行于浏览器，可以控制打开的作用域范围下所有的页面请求，可拦截请求和返回，缓存文件；sw 可以通过 fetch 这个 api，来拦截网络和处理网络请求，再配合 cacheStorage 来实现 web 页面的缓存管理以及与前端 postMessage 通信</li> <li>单独的作用域范围，单独的运行环境和执行环境</li> <li>不能操作页面 DOMM，可以通过是事件机制来处理</li> <li>完全异步，同步 API（如 XHR 和 localStorage）不能再 service work 中使用，sw 大量使用 promise</li> <li>一旦被 install，就永远存在，除非被 uninstall 或者 dev 模式手动删除</li> <li>响应推送</li> <li>service worker 是事件驱动的 worker，生命周期与页面无关。 关联页面未关闭时，它也可以退出，没有关联页面时，它也可以启动。</li></ul> <h4 id="service-worker-的生命周期"><a href="#service-worker-的生命周期" class="header-anchor">#</a> 🍅 service worker 的生命周期 <span class="badge tip" style="vertical-align:top;" data-v-76652c5d>重要</span></h4> <p><font color="red">注册 -&gt; 安装 -&gt; 激活 -&gt; 废弃</font></p> <ul><li><p>installing（安装中）</p> <p>这个状态发生在 service worker 注册之后，表示开始安装，同时会进入 service Worker 的 install 事件中，触发 install 的事件回调指定一些静态资源进行离线缓存</p></li> <li><p>install(安装后)</p> <p>安装完成，进入了 waiting 状态，等待其他 Service worker 被关闭，所以当前脚本尚未激活，处于等待中；可以通过 self.skipWaiting()跳过等待</p></li> <li><p>activating（激活中）</p> <p>等待激活，在这个状态下没有被其他的 Servie Worker 控制的客户端，允许当前 worker 完成安装，并且清除了了其他的 worker 以及关联缓存的旧缓存资源（在 acitive 的事件回调中，可以调用 self.clients.claim()）</p></li> <li><p>activated（激活后）</p> <p>在这个状态会处理 actived 事件回调，并且提供处理功能性事件：fetch（请求）、sync（后台同步）、push（推送）</p></li> <li><p>redundant（废弃）</p> <p>表示一个 Service Worker 的生命周期结束</p></li></ul> <h4 id="service-worker-的优势"><a href="#service-worker-的优势" class="header-anchor">#</a> service worker 的优势</h4> <ol><li>支持离线访问</li> <li>加载速度快</li> <li>离线状态下的可用性</li></ol> <p>就算已经关闭了页面，它也能帮助我们继续发送代理的请求</p> <h4 id="service-worker-的安全策略"><a href="#service-worker-的安全策略" class="header-anchor">#</a> service worker 的安全策略</h4> <p>由于 service worker 功能强大，可以修改任何通过它的请求，因此需要对其进行一定的安全限制</p> <ol><li><p>使用 https 或者本地的 localhost 才能使用 Service Worker</p></li> <li><p>Service Worker 都有一个有限的控制范围，这个范围通过放置 Service Worker 的 js 文件的目录决定的，也就是 Service Worker 所在目录以及所有的子目录。</p></li></ol> <p>也可以通过注册 Service Worker 的时候传入一个<code>scope</code>选项，用来覆盖默认的作用域，但是只能将作用域的范围缩小，不能将它扩大。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'serviceworker.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> scope<span class="token operator">:</span> <span class="token string">'/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_3-9-1-小试牛刀"><a href="#_3-9-1-小试牛刀" class="header-anchor">#</a> 3.9.1 小试牛刀</h3> <p>源码地址：/Senior-FrontEnd/examples/jsadvanced/3.9</p> <ol><li>新建 index.html</li></ol> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>test1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./sw.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          navigator<span class="token punctuation">.</span>serviceWorker
            <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./sw.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> scope<span class="token operator">:</span> <span class="token string">'/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">registration</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
                <span class="token string">'ServiceWorker 注册成功！作用域为: '</span><span class="token punctuation">,</span>
                registration<span class="token punctuation">.</span>scope
              <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ServiceWorker 注册失败: '</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ol start="2"><li>新建 sw.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'cache'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cache</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 缓存index.html文件</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 匹配返回缓存资源</span>
      <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol start="3"><li>启动一个服务</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>browser-sync start --server <span class="token comment"># 在3.9文件夹下</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="4"><li>打开地址：http://localhost:3000</li></ol> <p><img src="/assets/img/sw1.d77ae24b.png" alt=""></p> <ol start="5"><li>关闭服务</li></ol> <p>关闭刚刚启动的服务，发现照样能访问资源，只不过控制台会出现一行报错<code>sw.js:1 Uncaught SyntaxError: Unexpected token '&lt;'</code></p> <div class="custom-block tip"><p class="custom-block-title">查看自己的浏览器上有哪些网站用了 service worker</p> <p>浏览器访问：chrome://serviceworker-internals/</p></div> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>这章我们学习了异步编程的解决方法</p> <p>回调-&gt;发布订阅-&gt;promise-&gt;Generator-&gt;async/await</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/13/2025, 7:45:34 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/jsadvanced/function.html" class="prev">函数</a></span> <span class="next"><a href="/jsadvanced/designpattern.html">设计模式</a>
      →
    </span></p></div> </main> <footer class="footer" data-v-266a5a28><div class="container" data-v-266a5a28><p class="text-center" data-v-266a5a28>© 2024 web全栈体系. All Rights Reserved.（所有文章未经授权禁止转载、摘编、复制或建立镜像，如有违反，追究法律责任。）</p> <p class="text-center" data-v-266a5a28><a href="https://beian.miit.gov.cn" target="_blank" data-v-266a5a28>豫ICP备19041317号-1</a></p></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0f616eb6.js" defer></script><script src="/assets/js/3.9750fba5.js" defer></script><script src="/assets/js/2.6aa46093.js" defer></script><script src="/assets/js/5.e06ff02e.js" defer></script><script src="/assets/js/27.c05d3044.js" defer></script>
  </body>
</html>
