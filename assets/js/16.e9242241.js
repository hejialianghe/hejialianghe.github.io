(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{167:function(t,e,a){t.exports=a.p+"assets/img/cache.264b3c83.png"},168:function(t,e,a){t.exports=a.p+"assets/img/FIFO.ad7466f6.png"},169:function(t,e,a){t.exports=a.p+"assets/img/Frequently.46c13a98.png"},170:function(t,e,a){t.exports=a.p+"assets/img/recently.41fd5119.png"},171:function(t,e,a){t.exports=a.p+"assets/img/max-age.44f6cec8.png"},339:function(t,e,a){"use strict";a.r(e);var s=a(0),r=Object(s.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"_2-5-缓存、清理缓存和http缓存"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-缓存、清理缓存和http缓存"}},[t._v("#")]),t._v(" 2.5 缓存、清理缓存和HTTP缓存")]),t._v(" "),s("h3",{attrs:{id:"_2-5-1-缓存"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-1-缓存"}},[t._v("#")]),t._v(" 2.5.1 缓存")]),t._v(" "),s("ul",[s("li",[t._v("缓存将被用到的数据，让数据访问更快\n"),s("ul",[s("li",[t._v("命中：在缓存中找到了请求的数据")]),t._v(" "),s("li",[t._v("不命中/穿透：缓存中没有需要的数据")]),t._v(" "),s("li",[t._v("命中率：命中次数/总次数")]),t._v(" "),s("li",[t._v("缓存大小：缓存中一共可以存多少数据")]),t._v(" "),s("li",[t._v("清空策略：如果缓存空间不够数据如何让被替换")])])])]),t._v(" "),s("img",{attrs:{width:"300px",src:a(167)}}),t._v(" "),s("h4",{attrs:{id:"清空策略-fifo"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#清空策略-fifo"}},[t._v("#")]),t._v(" 清空策略（FIFO）")]),t._v(" "),s("p",[t._v("这是一种清空策略，它是先进先出；假如我们现在有100条数据，存储的方向是从一个链表的尾部插入，从一个链表的头部取出；假设我们是这样的一个算法。\n当我们现有的数据小于100的时候，我们可以一直存入；当现有数据等于100的时候，我们每存入一个就需要取出一个，从头部存入，从尾部取出；这样就会产生一个结果，\n我们最早存入的数据最早取出，这样就构成了先进先出。")]),t._v(" "),s("img",{attrs:{width:"500px",src:a(168)}}),t._v(" "),s("h4",{attrs:{id:"lru-least-frequently-used-使用频率最低的"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lru-least-frequently-used-使用频率最低的"}},[t._v("#")]),t._v(" LRU-Least Frequently used(使用频率最低的)")]),t._v(" "),s("p",[t._v("当缓存不够时，优先清除使用频率最低的")]),t._v(" "),s("img",{attrs:{width:"500px",src:a(169)}}),t._v(" "),s("h4",{attrs:{id:"lru-least-recently-used-最近使用的"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lru-least-recently-used-最近使用的"}},[t._v("#")]),t._v(" LRU-Least recently used(最近使用的)")]),t._v(" "),s("p",[t._v("假如最近一年前的记录，最近使用了，会更新成最近的")]),t._v(" "),s("img",{attrs:{width:"500px",src:a(170)}}),t._v(" "),s("h3",{attrs:{id:"_2-5-2-http缓存"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-2-http缓存"}},[t._v("#")]),t._v(" 2.5.2 http缓存")]),t._v(" "),s("p",[t._v("http缓存，主要是通过协议头，分别为协商缓存和强制缓存。")]),t._v(" "),s("h4",{attrs:{id:"缓存策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#缓存策略"}},[t._v("#")]),t._v(" 缓存策略")]),t._v(" "),s("p",[t._v("当浏览器第一次加载资源时，服务端可以在响应头中返回缓存策略，浏览器会把这些缓存策略放在缓存中，当以后再次请求时浏览器通过"),s("code",[t._v("expires")]),t._v("和"),s("code",[t._v("cache-control")]),t._v("判断是否命中缓存且没有过期，如果命中返回200状态码并从缓存中读取数据，如果没有命中强缓存，浏览器会发送一个请求并携带"),s("code",[t._v("last-modified")]),t._v("、"),s("code",[t._v("e-tag")]),t._v("咨询服务端资源是否过期，如果服务端返回304状态码，说明没过期让浏览器从缓存中读取，如果过期了浏览器则会重新请求资源。")]),t._v(" "),s("h4",{attrs:{id:"cache-control"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cache-control"}},[t._v("#")]),t._v(" 🍅 Cache-Control "),s("Badge",{attrs:{text:"重要",type:"tip"}})],1),t._v(" "),s("p",[t._v("这个头定义所有缓存都要遵守的行为，不管是协商缓存还是强制缓存")]),t._v(" "),s("ul",[s("li",[t._v("可缓存性（要不要缓存）")])]),t._v(" "),s("p",[t._v("大体有2种情况，一种是客户端要不要缓存，还有一种是中间方要不要缓存；因为我们一个请求从发出到响应可能还经历了其他服务器，可能还经过中间的代理服务器，这里定义了中间的服务器它们需不需缓存。")]),t._v(" "),s("p",[t._v("如果允许中间方缓存就定义成"),s("code",[t._v("public")]),t._v("。")]),t._v(" "),s("p",[t._v("如果不允许中间方缓存，只允许端缓存我们就定义成"),s("code",[t._v("private")]),t._v("。")]),t._v(" "),s("p",[t._v("如果需要所有人都不缓存那就定义成"),s("code",[t._v("no-store")]),t._v("。")]),t._v(" "),s("p",[t._v("如果你希望要不要缓存是一个协商的行为，那么你可以用"),s("code",[t._v("no-cache")]),t._v(",就是每次请求前先问一下服务端是不是最新的，如果不是最新的就不用再次请求。")]),t._v(" "),s("p",[t._v("这几个值可以组合。")]),t._v(" "),s("ul",[s("li",[t._v("可缓存性")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("值")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("含义")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("public")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("允许所有方缓存")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("private")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("只允许浏览器缓存")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("no-cache")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("每次必须先询问服务器资源是都已经更新")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("no-store")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("禁止缓存")])])])]),t._v(" "),s("ul",[s("li",[t._v("缓存期限（要不要缓存）")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("值")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("含义")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("max-age")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("秒（存储周期）")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("s-maxage")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("秒（共享缓存如代理等，存储周期）")])])])]),t._v(" "),s("h4",{attrs:{id:"cache-control-常用用法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cache-control-常用用法"}},[t._v("#")]),t._v(" Cache-Control 常用用法")]),t._v(" "),s("p",[t._v("不同文件，"),s("code",[t._v("cache-control")]),t._v("不同的用法：")]),t._v(" "),s("p",[t._v("第一个文件：react、vue、jquery这些库我们会把期限设置成最大，原因是这种更新周期是非常慢的，如果要更新这个文件我们可以更改文件名的hash值，这样文件名变了又可以请求新的文件了。如果我们什么都不写，就是允许公有方，像cdn、代理服务器它们都可以缓存这个文件。")]),t._v(" "),s("p",[t._v("第二个文件：这种自己的库，会设置成private，就是我们不允许中间方缓存，这里面可能有我们敏感的算法；造成不必要的麻烦，如果变化不大的情况下，max-age也设置成很大的值。")]),t._v(" "),s("p",[t._v("第三个文件：变化情况不大的情况下，max-age可以设置成很大的值。")]),t._v(" "),s("p",[t._v("第四个文件：图片的名字也没有带hash，可能存在一个更新问题，所以我们把它的时间设置成一天。")]),t._v(" "),s("img",{attrs:{width:"500px",src:a(171)}}),t._v(" "),s("h4",{attrs:{id:"强制缓存"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#强制缓存"}},[t._v("#")]),t._v(" 🍅 强制缓存 "),s("Badge",{attrs:{text:"重要",type:"tip"}})],1),t._v(" "),s("p",[t._v("强制使用缓存，不去服务器对比；（缓存生效不再发送请求）")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("Cache"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("control"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("max"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("age"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("600")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 600秒")]),t._v("\nExpires"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("最后期限"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 写一个具体日期，到什么时候失效，现在基本不用了")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("案例：")]),t._v(" "),s("div",{staticClass:"language-diff line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-diff"}},[s("code",[t._v("const express= require('express')\nconst app = express()\napp.get('/x',(req,res)=>{\n"),s("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[s("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v(' res.set("Cache-Control","max-age=600")\n')])]),s("span",{pre:!0,attrs:{class:"token unchanged"}},[s("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v("   res.send('x3')\n")])]),t._v("})\napp.listen(3000)\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("max-age=0 等于0的情况和no-cache的情况一样，每次都向服务器询问")]),t._v(" "),s("h4",{attrs:{id:"协商缓存1"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#协商缓存1"}},[t._v("#")]),t._v(" 🍅 协商缓存1 "),s("Badge",{attrs:{text:"重要",type:"tip"}})],1),t._v(" "),s("p",[t._v("协商使用缓存，每次需要向服务器请求对比，缓存生效下不传回body")]),t._v(" "),s("p",[t._v("服务端先返回一个"),s("code",[t._v("Last-Modified")]),t._v("告诉客户端这个资源最后修改时间，然后客户端每次发请求都回带上"),s("code",[t._v("if-Modified-Since")]),t._v(";如果资源变化了，服务就会知道，就会返回新的资源和新的Last-Modified")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("返回：Last"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Modified："),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("昨天"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" \n请求："),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Modified"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Since："),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("昨天"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("div",{staticClass:"language-diff line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-diff"}},[s("code",[t._v("const express= require('express')\nconst app = express()\napp.set('etag',false) // 先把etag关掉，因为它也是一种缓存,现在我们只用一种，好演示一些\napp.get('/x',(req,res)=>{\nres.set(\"Last-Modified\",\"Sun Feb 28 2021 23:24:47 GMT+0800\") // 如果资源变了需要更新这个时间\n"),s("span",{pre:!0,attrs:{class:"token unchanged"}},[s("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v("   res.send('x3')\n")])]),t._v("})\napp.listen(3000)\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])]),s("h4",{attrs:{id:"协商缓存2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#协商缓存2"}},[t._v("#")]),t._v(" 🍅 协商缓存2 "),s("Badge",{attrs:{text:"重要",type:"tip"}})],1),t._v(" "),s("p",[t._v("这个是用的最多的协商缓存，服务端在返回任何数据的时候，就会带上一个E-Tag；这个不用我们配置")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("返回："),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("E")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Tag"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1234")]),t._v("\n请求"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("None"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Match"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1234")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("h4",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 🍅 总结")]),t._v(" "),s("ol",[s("li",[t._v("发布新的静态资源的时候，如何更新缓存？")])]),t._v(" "),s("p",[t._v("每次发布的文件名都不同，这是用的最多的一种策略，因为我们的静态资源在html加载，或者被js引用到了；最后把这些引用都改成新的；webpack都有这些功能。")]),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[t._v("当强缓存（Cache-Control: max-age）和 协商缓存（ETag / Last-Modified）都设置时，命中策略是什么？")])]),t._v(" "),s("p",[t._v("先检查强缓存，且资源仍在有效期内（没过 max-age 时间），直接使用本地缓存，不发请求，状态码 200 (from disk/memory cache)；如果 max-age 过期，则检查协商缓存，发送请求时，浏览器会带上 If-None-Match（对应 ETag）或 If-Modified-Since（对应 Last-Modified）；服务器检查后，若资源未修改，返回 304 Not Modified，浏览器继续使用缓存。若资源已修改，返回 200 OK 和新资源。")])])}),[],!1,null,null,null);e.default=r.exports}}]);